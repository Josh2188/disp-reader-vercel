<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PTT 閱讀器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pinch-zoom-js@2.3.4/dist/pinch-zoom.umd.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #image-modal.hidden, #image-modal-controls.hidden { display: none; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .glassmorphism { background-color: rgba(255, 255, 255, 0.7); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); }
        .dark .glassmorphism { background-color: rgba(17, 24, 39, 0.7); }
        .pinch-zoom-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .pinch-zoom-container img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.1s ease-out; }
        .image-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #image-modal:hover .image-nav-btn { opacity: 1; }
        .image-nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }
        #image-prev-btn { left: 16px; }
        #image-next-btn { right: 16px; }
        html, body { height: 100%; margin: 0; }
        body { display: flex; flex-direction: column; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <!-- Header (now full-width) -->
    <header id="main-header" class="bg-gray-50/80 dark:bg-gray-900/80 shadow-sm sticky top-0 z-20 p-3 glassmorphism w-full">
        <div class="max-w-7xl mx-auto flex items-center gap-2">
            <button id="header-back-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 hidden lg:hidden"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
            <div class="w-full lg:w-1/3">
                <select id="board-selector" class="bg-gray-200 dark:bg-gray-700 border-none text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
            </div>
            <h2 id="header-title" class="font-bold text-lg truncate flex-grow hidden"></h2>
            
            <div class="flex-shrink-0 flex items-center gap-1">
                <button id="header-favorite-btn" class="p-2 rounded-full hover:bg-pink-100 dark:hover:bg-pink-900/50 hidden">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
                </button>
                <button id="show-favorites-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
                </button>
                <button id="fullscreen-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg id="fullscreen-enter-icon" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>
                    <svg id="fullscreen-exit-icon" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9V4.5M15 9h4.5M15 9l5.25-5.25M15 15v4.5M15 15h4.5M15 15l5.25 5.25" /></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-grow max-w-7xl w-full mx-auto lg:flex lg:gap-4 overflow-hidden p-4">
        <!-- Left Column (List View) -->
        <div id="app-container" class="w-full lg:w-1/3 lg:max-w-md bg-white dark:bg-black text-gray-900 dark:text-gray-100 shadow-lg flex flex-col h-full rounded-lg">
            <div id="list-view" class="flex-grow flex flex-col h-full overflow-hidden">
                <div id="skeleton-container" class="flex-grow divide-y divide-gray-200 dark:divide-gray-700 overflow-y-auto no-scrollbar p-2"></div>
                <main id="articles-list" class="flex-grow divide-y divide-gray-200 dark:divide-gray-700 overflow-y-auto no-scrollbar hidden"></main>
                <div id="infinite-loader" class="flex justify-center items-center py-4 hidden"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div></div>
                <div id="list-error" class="text-center py-20 text-red-500 hidden"><p id="list-error-text"></p></div>
            </div>
        </div>
        
        <!-- Right Column (Detail View for Desktop) -->
        <div id="desktop-detail-container" class="hidden lg:flex flex-grow bg-white dark:bg-black shadow-lg flex-col h-full rounded-lg">
             <div id="detail-view" class="h-full">
                <main id="detail-content" class="h-full overflow-y-auto no-scrollbar p-4"></main>
            </div>
        </div>
    </div>

    <!-- Mobile Detail View (Overlay) -->
    <div id="mobile-detail-view" class="lg:hidden fixed inset-0 bg-white dark:bg-black z-30 hidden flex-col">
        <main id="mobile-detail-content" class="h-full overflow-y-auto no-scrollbar"></main>
    </div>

    <!-- Image Modal & Controls -->
    <div id="image-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-2 glassmorphism" onclick="handleCloseRequest(event)">
        <div id="pinch-zoom-target" class="pinch-zoom-container"></div>
        <button id="image-prev-btn" class="image-nav-btn"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
        <button id="image-next-btn" class="image-nav-btn"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
    </div>
    <div id="image-modal-controls" class="hidden fixed top-0 right-0 m-4 flex gap-2 z-[60]">
        <a id="download-btn" href="#" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 focus:outline-none"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></a>
        <button id="close-modal-btn" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 focus:outline-none" onclick="handleCloseRequest(event)"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
    </div>
    
    <button id="floating-back-btn" class="hidden lg:hidden fixed bottom-5 left-1/2 -translate-x-1/2 z-50 p-3 bg-black/40 text-white rounded-full transition-opacity duration-300 opacity-0 hover:bg-black/60">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
    </button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = {
              apiKey: "AIzaSyBVK9oYxwz7Wrg4d5dz1eNQyRTigDtHxbQ",
              authDomain: "my-english-learning-app-5d864.firebaseapp.com",
              projectId: "my-english-learning-app-5d864",
              storageBucket: "my-english-learning-app-5d864.firebasestorage.app",
              messagingSenderId: "748913890079",
              appId: "1:748913890079:web:dad0719760593d43e7962a",
              measurementId: "G-4Q99XJZJ5Z"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            let userId = null;

            const cache = {
                CACHE_PREFIX: 'ptt-cache-',
                EXPIRATION_DAYS: 7,
                get(key) {
                    const fullKey = this.CACHE_PREFIX + key;
                    const itemStr = localStorage.getItem(fullKey);
                    if (!itemStr) return null;
                    try {
                        const item = JSON.parse(itemStr);
                        const now = new Date();
                        const expirationTime = this.EXPIRATION_DAYS * 24 * 60 * 60 * 1000;
                        if (now.getTime() > item.timestamp + expirationTime) {
                            localStorage.removeItem(fullKey);
                            return null;
                        }
                        return item.data;
                    } catch (e) {
                        localStorage.removeItem(fullKey);
                        return null;
                    }
                },
                set(key, data) {
                    const fullKey = this.CACHE_PREFIX + key;
                    const item = { data: data, timestamp: new Date().getTime() };
                    try {
                        localStorage.setItem(fullKey, JSON.stringify(item));
                    } catch (e) { console.error("Error saving to cache", e); }
                }
            };

            let state = {
                currentBoard: 'Gossiping',
                prevPageUrl: null,
                isLoading: false,
                currentView: 'list',
                currentArticle: null,
                favorites: [],
                readArticles: new Set(JSON.parse(localStorage.getItem('readArticles')) || []),
                pinchZoomInstance: null,
                inactivityTimer: null,
                currentArticleImages: [],
                currentImageIndex: 0,
                galleryActivityTimer: null,
                activeArticleLink: null
            };

            // DOM Elements...
            const docEl = document.documentElement;
            const articlesList = document.getElementById('articles-list');
            const skeletonContainer = document.getElementById('skeleton-container');
            const infiniteLoader = document.getElementById('infinite-loader');
            const listError = document.getElementById('list-error');
            const listErrorText = document.getElementById('list-error-text');
            const boardSelector = document.getElementById('board-selector');
            const headerBackBtn = document.getElementById('header-back-btn');
            const headerTitle = document.getElementById('header-title');
            const headerFavoriteBtn = document.getElementById('header-favorite-btn');
            const detailContent = document.getElementById('detail-content');
            const mobileDetailView = document.getElementById('mobile-detail-view');
            const mobileDetailContent = document.getElementById('mobile-detail-content');
            const showFavoritesBtn = document.getElementById('show-favorites-btn');
            const floatingBackBtn = document.getElementById('floating-back-btn');
            const imageModal = document.getElementById('image-modal');
            const imageModalControls = document.getElementById('image-modal-controls');
            const imagePrevBtn = document.getElementById('image-prev-btn');
            const imageNextBtn = document.getElementById('image-next-btn');
            
            const TOP_BOARDS = { "Gossiping": "八卦", "C_Chat": "希洽", "Stock": "股票", "Lifeismoney": "省錢", "MobileComm": "手機", "NBA": "NBA", "Baseball": "棒球", "Boy-Girl": "男女", "Tech_Job": "科技業", "Car": "汽車", "Beauty": "表特", "HatePolitics": "政黑", "KoreaStar": "韓星", "movie": "電影", "e-shopping": "網購" };

            const isDesktop = () => window.innerWidth >= 1024;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    const favsCol = collection(db, 'users', userId, 'favorites');
                    onSnapshot(favsCol, (snapshot) => {
                        state.favorites = snapshot.docs.map(doc => doc.data());
                        if (state.currentView === 'favorites') renderArticles(state.favorites);
                        if(state.currentView === 'detail' && state.currentArticle) {
                            updateFavoriteIcon(isFavorite(state.currentArticle.link));
                        }
                    });
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Anonymous sign-in failed:", error);
                        listErrorText.textContent = "無法連接到雲端同步服務，請檢查 API 金鑰是否正確。";
                        listError.classList.remove('hidden');
                        skeletonContainer.classList.add('hidden');
                    });
                }
            });

            const saveReadArticles = () => localStorage.setItem('readArticles', JSON.stringify([...state.readArticles]));
            const isFavorite = (link) => state.favorites.some(fav => fav.link === link);

            function linkify(text) {
                if (!text) return '';
                const urlRegex = /(?<!href="|src=")(https?:\/\/[^\s<>"']+)/g;
                return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-500 dark:text-blue-400 hover:underline">${url}</a>`);
            }
            
            function updateFavoriteIcon(isFav) {
                const svg = headerFavoriteBtn.querySelector('svg');
                if (svg) {
                    svg.classList.toggle('text-pink-500', isFav);
                    svg.classList.toggle('fill-current', isFav);
                    svg.classList.toggle('text-gray-400', !isFav);
                }
            }

            function updateHeader() {
                const isDetail = state.currentView === 'detail';
                boardSelector.parentElement.classList.toggle('hidden', isDetail && !isDesktop());
                showFavoritesBtn.classList.toggle('hidden', isDetail && !isDesktop());
                headerBackBtn.classList.toggle('hidden', !isDetail || isDesktop());
                headerTitle.classList.toggle('hidden', !isDetail);
                headerFavoriteBtn.classList.toggle('hidden', !isDetail);

                if (isDetail && state.currentArticle) {
                    headerTitle.textContent = state.currentArticle.title;
                    updateFavoriteIcon(isFavorite(state.currentArticle.link));
                }
            }
            
            function createListItem(article) {
                const item = document.createElement('div');
                const isRead = state.readArticles.has(article.link);
                item.className = `flex items-start p-3 gap-3 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer ${isRead ? 'opacity-60' : ''}`;
                item.dataset.link = article.link;
                
                if (article.link === state.activeArticleLink) {
                    item.classList.add('bg-blue-100', 'dark:bg-blue-900/50');
                }
                
                let thumbnailHTML = '';
                if (article.thumbnail) {
                    const secureThumbnail = article.thumbnail.replace(/^http:\/\//i, 'https://');
                    thumbnailHTML = `<div class="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden"><img src="${secureThumbnail}" alt="thumbnail" class="w-full h-full object-cover" loading="lazy"></div>`;
                }

                const displayDate = article.timestamp || article.date;

                item.innerHTML = `
                    <div class="flex flex-col overflow-hidden flex-grow">
                        <h3 class="font-bold text-base leading-tight line-clamp-2 text-gray-900 dark:text-blue-300">${article.title}</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 truncate">${article.author} - ${displayDate}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 line-clamp-2">${article.snippet || ''}</p>
                    </div>
                    ${thumbnailHTML}
                `;
                item.addEventListener('click', () => showDetailView(article));
                return item;
            }

            function renderArticles(articleData, append = false) {
                if (!append) articlesList.innerHTML = '';
                if (articleData.length === 0) {
                    articlesList.innerHTML = `<p class="p-4 text-center text-gray-500">${state.currentView === 'favorites' ? '尚未收藏任何文章' : '沒有文章'}</p>`;
                } else {
                    articleData.forEach(article => articlesList.appendChild(createListItem(article)));
                }
            }
            
            async function loadArticles(board, url = null, append = false) {
                if (state.isLoading) return;
                
                const fetchUrl = url || `https://www.ptt.cc/bbs/${board}/index.html`;

                if (!append) {
                    state.currentView = 'list';
                    articlesList.innerHTML = '';
                    listError.classList.add('hidden');
                    updateHeader();
                }

                const cachedData = cache.get(fetchUrl);
                if (!append && cachedData) {
                    state.prevPageUrl = cachedData.prev_page_url;
                    renderArticles(cachedData.articles, false);
                    articlesList.classList.remove('hidden');
                    skeletonContainer.classList.add('hidden');
                    return;
                }

                state.isLoading = true;
                
                if (append) infiniteLoader.classList.remove('hidden');
                else showSkeleton();

                try {
                    const response = await fetch(`/api/scraper?board=${board}&list_url=${encodeURIComponent(fetchUrl)}`);
                    if (!response.ok) throw new Error(`請求失敗: ${response.status}`);
                    const data = await response.json();
                    
                    if (!append) cache.set(fetchUrl, data);
                    
                    state.prevPageUrl = data.prev_page_url;
                    renderArticles(data.articles.filter(a => a.title && !a.title.includes('[公告]')), append);
                } catch (error) {
                    listErrorText.textContent = error.message;
                    listError.classList.remove('hidden');
                    if (!append) skeletonContainer.classList.add('hidden');
                } finally {
                    state.isLoading = false;
                    if (!append) hideSkeleton();
                    infiniteLoader.classList.add('hidden');
                }
            }
            
            async function toggleFavorite() {
                if (!state.currentArticle || !userId) return;
                const article = state.currentArticle;
                const favsCol = collection(db, 'users', userId, 'favorites');
                const docId = article.link.replace(/[^a-zA-Z0-9]/g, '');
                const docRef = doc(favsCol, docId);

                if (isFavorite(article.link)) await deleteDoc(docRef);
                else await setDoc(docRef, article);
            }

            async function showDetailView(article) {
                state.currentArticle = article;
                state.currentView = 'detail';
                
                if (state.activeArticleLink) {
                    const oldActive = articlesList.querySelector(`[data-link="${state.activeArticleLink}"]`);
                    oldActive?.classList.remove('bg-blue-100', 'dark:bg-blue-900/50');
                }
                const newActive = articlesList.querySelector(`[data-link="${article.link}"]`);
                newActive?.classList.add('bg-blue-100', 'dark:bg-blue-900/50');
                state.activeArticleLink = article.link;

                updateHeader();

                if (!state.readArticles.has(article.link)) {
                    state.readArticles.add(article.link);
                    saveReadArticles();
                    newActive?.classList.add('opacity-60');
                }
                
                const targetContent = isDesktop() ? detailContent : mobileDetailContent;
                const targetView = isDesktop() ? null : mobileDetailView;

                if (targetView) {
                    targetView.classList.remove('hidden');
                    targetView.classList.add('flex');
                }
                floatingBackBtn.classList.remove('hidden');
                showFloatingBackButton();
                targetContent.innerHTML = '<div class="flex justify-center items-center py-20"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-16 w-16"></div></div>';
                
                if (!isDesktop()) history.pushState({view: 'detail'}, '', '#detail');

                const articleUrl = article.link;
                const cachedData = cache.get(articleUrl);
                if (cachedData) {
                    state.currentArticleImages = cachedData.images || [];
                    renderDetailContent(cachedData, article);
                    return;
                }

                try {
                    const response = await fetch(`/api/scraper?article_url=${encodeURIComponent(articleUrl)}`);
                    if (!response.ok) throw new Error(`無法載入內文: ${response.status}`);
                    const data = await response.json();
                    
                    state.currentArticleImages = data.images || [];
                    cache.set(articleUrl, data);
                    renderDetailContent(data, article);
                } catch (error) {
                    targetContent.innerHTML = `<p class="text-red-500 font-bold p-4">${error.message}</p>`;
                }
            }
            
            function renderDetailContent(data, article) {
                const targetContent = isDesktop() ? detailContent : mobileDetailContent;
                let processedContent = data.content;
                let processedSignature = data.signature || '';
                
                data.images.forEach(imgUrl => {
                    const secureImgUrl = imgUrl.replace(/^http:\/\//i, 'https://');
                    const imgTag = `<img src="${secureImgUrl}" alt="文章圖片" class="article-image my-4 rounded-lg max-w-full h-auto cursor-pointer hover:opacity-80">`;
                    const urlRegex = new RegExp(imgUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '(?!")', 'g');
                    processedContent = processedContent.replace(urlRegex, imgTag);
                    if (processedSignature) processedSignature = processedSignature.replace(urlRegex, imgTag);
                });

                const signatureHTML = processedSignature ? `<div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400 whitespace-pre-wrap break-words">--\n${linkify(processedSignature)}</div>` : '';
                
                let pushesHTML = '';
                if (data.pushes?.length > 0) {
                    pushesHTML = `<div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">${data.pushes.map(p => {
                        let tagColor = 'text-gray-500 dark:text-gray-400';
                        if (p.tag === '推') tagColor = 'text-green-500 dark:text-green-400';
                        if (p.tag === '噓') tagColor = 'text-red-500 dark:text-red-400';
                        return `<div class="flex text-sm mt-1 gap-2"><span class="font-bold ${tagColor}">${p.tag}</span><span class="font-semibold text-blue-500 dark:text-blue-400">${p.userid}</span><span class="flex-grow">${linkify(p.content)}</span></div>`;
                    }).join('')}</div>`;
                }
                targetContent.innerHTML = `<div class="p-4"><div class="p-3 rounded-lg text-sm mb-4 bg-gray-100 dark:bg-gray-800"><p><strong>看板:</strong> ${article.board}</p><p><strong>作者:</strong> ${data.author_full}</p><p><strong class="dark:text-blue-300">標題:</strong> ${article.title}</p><p><strong>時間:</strong> ${data.timestamp}</p></div><div class="text-base leading-relaxed whitespace-pre-wrap break-words">${linkify(processedContent)}</div>${signatureHTML}${pushesHTML}</div>`;
                targetContent.scrollTop = 0;
            }

            // --- EVENT LISTENERS & INITIALIZATION ---
            function goBack() { history.back(); }

            boardSelector.addEventListener('change', (e) => {
                state.currentBoard = e.target.value;
                loadArticles(state.currentBoard);
            });
            showFavoritesBtn.addEventListener('click', () => {
                state.currentView = 'favorites';
                renderArticles(state.favorites);
                updateHeader();
                hideSkeleton();
                listError.classList.add('hidden');
            });
            headerFavoriteBtn.addEventListener('click', toggleFavorite);
            headerBackBtn.addEventListener('click', goBack);
            floatingBackBtn.addEventListener('click', goBack);
            
            window.addEventListener('popstate', (event) => {
                if (!imageModal.classList.contains('hidden')) {
                    closeImageModal();
                } else if (!isDesktop() && state.currentView === 'detail') {
                    state.currentView = 'list';
                    mobileDetailView.classList.add('hidden');
                    floatingBackBtn.classList.add('hidden');
                    updateHeader();
                }
            });

            articlesList.addEventListener('scroll', () => {
                if (state.isLoading || !state.prevPageUrl || state.currentView !== 'list') return;
                const { scrollTop, scrollHeight, clientHeight } = articlesList;
                if (scrollTop + clientHeight >= scrollHeight - 300) {
                    loadArticles(state.currentBoard, state.prevPageUrl, true);
                }
            });

            for (const board_en in TOP_BOARDS) {
                const option = document.createElement('option');
                option.value = board_en;
                option.textContent = `${TOP_BOARDS[board_en]}`;
                boardSelector.appendChild(option);
            }
            history.replaceState({view: 'list'}, '', '#list');
            loadArticles(state.currentBoard);
            
            if (isDesktop()) {
                detailContent.innerHTML = `<div class="flex h-full items-center justify-center text-gray-400"><p>請從左側選擇一篇文章來閱讀</p></div>`;
            }

            const pinchZoomTarget = document.getElementById('pinch-zoom-target');
            const downloadBtn = document.getElementById('download-btn');
            
            document.body.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('article-image')) {
                    const clickedSrc = e.target.src;
                    const imageIndex = state.currentArticleImages.indexOf(clickedSrc);
                    if (imageIndex > -1) {
                        state.currentImageIndex = imageIndex;
                        openImageModal();
                    }
                }
            });

            function openImageModal() {
                // FIXED: Safety check for destroy method
                if (state.pinchZoomInstance && typeof state.pinchZoomInstance.destroy === 'function') {
                    state.pinchZoomInstance.destroy();
                }
                state.pinchZoomInstance = null;
                
                pinchZoomTarget.innerHTML = '';
                
                const imageUrl = state.currentArticleImages[state.currentImageIndex];
                if (!imageUrl) return;

                const newImg = document.createElement('img');
                newImg.src = imageUrl;
                pinchZoomTarget.appendChild(newImg);

                downloadBtn.href = imageUrl;
                imageModal.classList.remove('hidden');
                imageModalControls.classList.remove('hidden');
                updateImageNavButtons();
                history.pushState({ view: 'image-modal' }, 'Image', '#image');

                // --- NEW: Desktop Zoom & Pan ---
                if (!('ontouchstart' in window)) {
                    let scale = 1, panning = false, start = { x: 0, y: 0 }, transform = { x: 0, y: 0 };
                    
                    const updateTransform = () => {
                        newImg.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${scale})`;
                    };

                    pinchZoomTarget.onwheel = (e) => {
                        e.preventDefault();
                        const delta = e.deltaY > 0 ? -0.1 : 0.1;
                        scale = Math.min(Math.max(1, scale + delta), 4);
                        if (scale === 1) {
                            transform = { x: 0, y: 0 };
                        }
                        updateTransform();
                    };

                    pinchZoomTarget.onmousedown = (e) => {
                        e.preventDefault();
                        if (scale > 1) {
                            panning = true;
                            start = { x: e.clientX - transform.x, y: e.clientY - transform.y };
                            pinchZoomTarget.style.cursor = 'grabbing';
                        }
                    };

                    pinchZoomTarget.onmousemove = (e) => {
                        if (panning) {
                            e.preventDefault();
                            transform.x = e.clientX - start.x;
                            transform.y = e.clientY - start.y;
                            updateTransform();
                        }
                    };
                    
                    const stopPan = () => {
                        panning = false;
                        pinchZoomTarget.style.cursor = 'grab';
                    };
                    pinchZoomTarget.onmouseup = stopPan;
                    pinchZoomTarget.onmouseleave = stopPan;
                } else {
                    try {
                        if (typeof PinchZoom === 'undefined' || !PinchZoom.default) {
                            throw new Error('PinchZoom library is not loaded correctly.');
                        }
                        state.pinchZoomInstance = new PinchZoom.default(pinchZoomTarget, { minZoom: 1, maxZoom: 4 });
                    } catch(e) {
                        console.error("PinchZoom failed to initialize:", e);
                        pinchZoomTarget.innerHTML = `<p class="text-red-500 p-4">圖片縮放功能載入失敗</p>`;
                    }
                }
            }
            
            function closeImageModal() {
                if (imageModal.classList.contains('hidden')) return;
                if (state.pinchZoomInstance && typeof state.pinchZoomInstance.destroy === 'function') state.pinchZoomInstance.destroy();
                state.pinchZoomInstance = null;
                imageModal.classList.add('hidden');
                imageModalControls.classList.add('hidden');
            };

            function showNextImage() {
                if (state.currentImageIndex < state.currentArticleImages.length - 1) {
                    state.currentImageIndex++;
                    openImageModal();
                }
            }

            function showPrevImage() {
                if (state.currentImageIndex > 0) {
                    state.currentImageIndex--;
                    openImageModal();
                }
            }

            function updateImageNavButtons() {
                imagePrevBtn.disabled = state.currentImageIndex === 0;
                imageNextBtn.disabled = state.currentImageIndex === state.currentArticleImages.length - 1;
            }
            
            imagePrevBtn.addEventListener('click', (e) => { e.stopPropagation(); showPrevImage(); });
            imageNextBtn.addEventListener('click', (e) => { e.stopPropagation(); showNextImage(); });

            window.handleCloseRequest = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                closeImageModal();
                if (history.state && history.state.view === 'image-modal') history.back();
            };

            downloadBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                const url = downloadBtn.href;
                const originalIcon = downloadBtn.innerHTML;
                
                downloadBtn.innerHTML = `<svg class="w-6 h-6 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const blob = await response.blob();
                    const objectUrl = window.URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = objectUrl;
                    a.download = url.split('/').pop().split('?')[0] || 'download.jpg';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(objectUrl);
                    a.remove();
                } catch (err) {
                    console.error('Download failed:', err);
                    alert('圖片下載失敗，可能是瀏覽器限制或網路問題。');
                } finally {
                    downloadBtn.innerHTML = originalIcon;
                }
            });
            
            const fullscreenToggle = document.getElementById('fullscreen-toggle');
            
            const applyTheme = (isDark) => docEl.classList.toggle('dark', isDark);
            
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            applyTheme(mediaQuery.matches);
            mediaQuery.addEventListener('change', (e) => applyTheme(e.matches));

            fullscreenToggle.addEventListener('click', () => {
                if (!document.fullscreenElement) document.body.requestFullscreen().catch(err => console.error(err));
                else if (document.exitFullscreen) document.exitFullscreen();
            });
            function showFloatingBackButton() {
                if (state.currentView !== 'detail') return;
                floatingBackBtn.classList.remove('opacity-0');
                clearTimeout(state.inactivityTimer);
                state.inactivityTimer = setTimeout(() => floatingBackBtn.classList.add('opacity-0'), 3000);
            }
            document.addEventListener('fullscreenchange', () => {
                const isFullscreen = !!document.fullscreenElement;
                document.getElementById('fullscreen-enter-icon').classList.toggle('hidden', isFullscreen);
                document.getElementById('fullscreen-exit-icon').classList.toggle('hidden', !isFullscreen);
            });
            document.addEventListener('mousemove', showFloatingBackButton);
            document.addEventListener('touchstart', showFloatingBackButton);
        });
    </script>
</body>
</html>
