<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    
    <title>PTT Reader</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#111827">
    <link rel="apple-touch-icon" href="/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pinch-zoom-js@2.3.4/dist/pinch-zoom.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spin 0.8s linear infinite; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 隱藏滾動條但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .glassmorphism { background-color: rgba(17, 24, 39, 0.95); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); }
        
        /* 圖片燈箱 */
        #image-modal.hidden, #image-modal-controls.hidden { display: none; }
        .pinch-zoom-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .pinch-zoom-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .image-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 61; }
        .image-nav-btn:disabled { opacity: 0.3; }
        #image-prev-btn { left: 16px; }
        #image-next-btn { right: 16px; }

        #toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); transition: bottom 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 100; pointer-events: none; }
        #toast-notification.show { bottom: 30px; }

        .push { display: flex; flex-wrap: wrap; align-items: baseline; margin-bottom: 0.5rem; line-height: 1.5; font-size: 0.95rem; }
        .push-tag { flex-shrink: 0; width: 2rem; font-weight: 600; text-align: center; }
        .push-tag-推 { color: #22c55e; } .push-tag-噓 { color: #ef4444; } .push-tag-→ { color: #9ca3af; }
        .push-userid { flex-shrink: 0; font-weight: 600; margin-right: 0.5rem; }
        .push-content { flex-grow: 1; color: #e5e7eb; }

        /* 美圖牆 */
        #gallery-grid { column-gap: 8px; padding: 4px; }
        .gallery-item { margin-bottom: 8px; break-inside: avoid; display: block; overflow: hidden; border-radius: 8px; background: #1f2937; position: relative; cursor: pointer; }
        .gallery-item img { width: 100%; height: auto; display: block; transition: opacity 0.3s; }
        .gallery-item:active img { opacity: 0.8; }
        
        #gallery-grid.size-sm { column-count: 2; }
        @media (min-width: 640px) { #gallery-grid.size-sm { column-count: 3; } }
        #gallery-grid.size-md { column-count: 2; }
        @media (min-width: 768px) { #gallery-grid.size-md { column-count: 3; } }
        #gallery-grid.size-lg { column-count: 1; }
        
        @media (min-width: 768px) { #app-container { max-width: 768px; border-left: 1px solid #374151; border-right: 1px solid #374151; } }
    </style>
</head>
<body class="bg-black text-gray-100 overflow-hidden">

    <div id="app-container" class="mx-auto bg-black h-[100dvh] flex flex-col relative">
        <header id="main-header" class="bg-gray-900 shadow-md flex-shrink-0 z-50 flex flex-col border-b border-gray-800">
            <div class="flex items-center justify-between p-3 pb-0">
                <h1 class="text-xl font-bold text-white tracking-wide pl-1 cursor-pointer" onclick="window.scrollTo(0,0)">PTT<span class="text-blue-500 text-sm ml-1">Reader</span></h1>
                
                <h2 id="header-title" class="font-bold text-lg truncate flex-grow hidden pl-2 text-white"></h2>

                <div id="list-view-controls" class="flex items-center gap-2">
                    <button id="toggle-sort-btn" class="p-2 rounded-full hover:bg-gray-700 text-gray-300 transition-colors">
                        <svg id="sort-time-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <svg id="sort-hot-icon" class="h-6 w-6 hidden text-red-500" viewBox="0 0 24 24" fill="currentColor"><path d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.362-3.797A8.333 8.333 0 0112 6c1.23 0 2.398.256 3.362.714z" /></svg>
                    </button>
                    <button id="toggle-favorites-btn" class="p-2 rounded-full hover:bg-gray-700 text-gray-300 hidden transition-colors">
                        <svg id="fav-icon-outline" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                        <svg id="fav-icon-solid" class="h-6 w-6 hidden text-pink-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </button>
                    <button id="gallery-size-toggle-btn" class="hidden p-2 rounded-full hover:bg-gray-700 text-gray-300 transition-colors">
                         <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    </button>
                    <div id="auth-container" class="flex-shrink-0 relative ml-1">
                         <button id="google-login-btn" class="bg-blue-600 text-white font-medium py-1 px-3 rounded text-xs hover:bg-blue-500 transition-colors">登入</button>
                         <div id="user-info" class="hidden relative">
                             <button id="avatar-btn" class="block w-8 h-8 rounded-full overflow-hidden border border-gray-500 focus:outline-none">
                                 <svg id="default-avatar" class="w-full h-full text-gray-400 bg-gray-700" fill="currentColor" viewBox="0 0 24 24"><path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                                 <img id="user-avatar" class="w-full h-full object-cover hidden" src="" alt="User" onerror="this.classList.add('hidden');document.getElementById('default-avatar').classList.remove('hidden');">
                             </button>
                             <div id="logout-dropdown" class="hidden absolute right-0 top-10 w-32 bg-gray-800 rounded shadow-xl py-2 z-[60] border border-gray-700">
                                 <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-700">登出</button>
                             </div>
                         </div>
                    </div>
                </div>

                <div id="detail-view-controls" class="flex-shrink-0 flex items-center gap-2 hidden ml-auto">
                    <button id="header-favorite-btn" class="p-2 rounded-full hover:bg-gray-800 text-gray-300 transition-colors">
                        <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
                    </button>
                </div>
            </div>

            <div class="w-full overflow-x-auto no-scrollbar py-2 px-3 flex items-center gap-2" id="board-tabs-container">
                </div>
        </header>

        <div class="flex-grow relative overflow-hidden w-full">
            <div id="list-view" class="absolute inset-0 flex flex-col w-full h-full">
                <main id="articles-list" class="flex-grow divide-y divide-gray-800 overflow-y-auto w-full pb-20"></main>
                <div id="skeleton-container" class="absolute inset-0 bg-black z-10 p-4 space-y-4 hidden"></div>
                <div id="loading-indicator" class="hidden absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-800/90 px-4 py-2 rounded-full flex items-center gap-2 shadow-lg z-20 border border-gray-700"><div class="loader w-4 h-4 rounded-full border-2 border-t-transparent border-blue-500"></div><span class="text-xs text-gray-300">載入中...</span></div>
            </div>

            <div id="detail-view" class="absolute inset-0 hidden bg-black z-30 flex flex-col">
                <main id="detail-content" class="flex-grow overflow-y-auto p-4 pb-24"></main>
            </div>

            <div id="gallery-view" class="absolute inset-0 hidden bg-black z-20 flex flex-col">
                <main id="gallery-grid" class="flex-grow overflow-y-auto pb-20"></main>
                <div id="gallery-loading" class="hidden absolute bottom-10 left-1/2 -translate-x-1/2 bg-black/80 p-2 rounded-full"><div class="loader w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div></div>
            </div>
        </div>
        
        <button id="floating-back-btn" class="hidden fixed bottom-6 right-6 z-40 p-4 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-500 transition-all active:scale-95"><svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg></button>
    </div>

    <div id="image-modal" class="hidden fixed inset-0 bg-black z-[100] flex flex-col animate-fade-in">
        <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-10 bg-gradient-to-b from-black/80 to-transparent">
            <button id="close-modal-btn" class="p-2 text-white hover:text-gray-300"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <div class="flex gap-4">
                <button id="download-btn" class="p-2 text-white hover:text-gray-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
                <button id="favorite-from-modal-btn" class="p-2 text-white hover:text-pink-500"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg></button>
            </div>
        </div>
        <div id="pinch-zoom-target" class="flex-grow pinch-zoom-container"></div>
        <button id="image-prev-btn" class="image-nav-btn"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
        <button id="image-next-btn" class="image-nav-btn"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
    </div>
    
    <div id="toast-notification" class="bg-gray-800 text-white text-sm font-medium py-3 px-6 rounded-full shadow-lg border border-gray-600"><p id="toast-message"></p></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const TOP_BOARDS = { "Hot": "熱門文章", "Gossiping": "八卦", "Beauty": "表特", "BeautyGallery": "美圖牆", "Sex": "西斯", "Stock": "股票", "C_Chat": "希洽", "Lifeismoney": "省錢", "MobileComm": "手機", "NBA": "NBA", "Baseball": "棒球", "Car": "汽車", "Tech_Job": "科技", "movie": "電影", "e-shopping": "網購" };
        
        const state = { 
            board: 'Hot', view: 'list', articles: [], nextPage: null, loading: false, 
            favorites: [], read: new Set(JSON.parse(localStorage.getItem('read_v2')||'[]')),
            imgs: [], imgIdx: 0, zoom: null, galSize: localStorage.getItem('gal_size') || 'sm'
        };

        const $ = id => document.getElementById(id);
        const els = {
            app: $('app-container'), header: $('main-header'), list: $('articles-list'), detail: $('detail-content'), 
            gal: $('gallery-grid'), title: $('header-title'), 
            tabsContainer: $('board-tabs-container'),
            skel: $('skeleton-container'), loader: $('loading-indicator'), 
            views: { list: $('list-view'), detail: $('detail-view'), gallery: $('gallery-view') },
            modal: $('image-modal'), zoomTgt: $('pinch-zoom-target'),
            auth: { btn: $('google-login-btn'), info: $('user-info'), avt: $('user-avatar'), defAvt: $('default-avatar'), drop: $('logout-dropdown') }
        };

        const app = initializeApp({ apiKey: "AIzaSyBVK9oYxwz7Wrg4d5dz1eNQyRTigDtHxbQ", authDomain: "my-english-learning-app-5d864.firebaseapp.com", projectId: "my-english-learning-app-5d864" });
        const auth = getAuth(app);
        const db = getFirestore(app);
        let uid = null;

        (function init() {
            renderBoardTabs();
            
            // Event Listeners
            $('toggle-sort-btn').onclick = () => {}; 
            $('floating-back-btn').onclick = () => goBack();
            $('header-favorite-btn').onclick = toggleFav;
            $('favorite-from-modal-btn').onclick = toggleFavModal;
            $('gallery-size-toggle-btn').onclick = toggleGalSize;
            $('toggle-favorites-btn').onclick = toggleShowFavs;

            els.list.addEventListener('scroll', throttle(() => {
                if(els.list.scrollTop + els.list.clientHeight > els.list.scrollHeight - 500) loadMore();
            }, 200));
            els.gal.addEventListener('scroll', throttle(() => {
                if(els.gal.scrollTop + els.gal.clientHeight > els.gal.scrollHeight - 500) loadMore();
            }, 200));

            $('close-modal-btn').onclick = closeModal;
            $('image-prev-btn').onclick = e => { e.stopPropagation(); chgImg(-1); };
            $('image-next-btn').onclick = e => { e.stopPropagation(); chgImg(1); };
            $('download-btn').onclick = downloadImg;

            els.auth.btn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
            $('logout-btn').onclick = () => signOut(auth);
            
            $('avatar-btn').onclick = e => { e.stopPropagation(); els.auth.drop.classList.toggle('hidden'); };
            document.onclick = () => els.auth.drop.classList.add('hidden');

            onAuthStateChanged(auth, u => {
                uid = u ? u.uid : null;
                els.auth.btn.classList.toggle('hidden', !!u);
                els.auth.info.classList.toggle('hidden', !u);
                $('toggle-favorites-btn').classList.toggle('hidden', !u);
                
                if(u) {
                    if(u.photoURL) {
                        els.auth.avt.src = u.photoURL;
                        els.auth.avt.classList.remove('hidden');
                        els.auth.defAvt.classList.add('hidden');
                    } else {
                        els.auth.avt.classList.add('hidden');
                        els.auth.defAvt.classList.remove('hidden');
                    }
                    onSnapshot(collection(db, 'users', uid, 'favorites'), s => {
                        state.favorites = s.docs.map(d => d.data());
                        updateFavIcons();
                    });
                }
            });
            
            loadBoard('Hot');
            applyGalSize();
        })();

        // 渲染橫向 Tab 標籤
        function renderBoardTabs() {
            els.tabsContainer.innerHTML = '';
            Object.entries(TOP_BOARDS).forEach(([k, v]) => {
                const btn = document.createElement('button');
                btn.textContent = v;
                btn.dataset.board = k;
                btn.className = `whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium transition-all duration-200 border snap-start ${
                    k === state.board 
                    ? 'bg-blue-600 text-white border-blue-500 shadow-md shadow-blue-900/40' 
                    : 'bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700 hover:text-gray-200'
                }`;
                
                btn.onclick = () => {
                    if (state.board === k) return;
                    updateActiveTab(k);
                    loadBoard(k);
                };
                els.tabsContainer.appendChild(btn);
            });
        }

        function updateActiveTab(boardKey) {
            const buttons = els.tabsContainer.querySelectorAll('button');
            buttons.forEach(btn => {
                if (btn.dataset.board === boardKey) {
                    btn.className = 'whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium transition-all duration-200 border border-blue-500 bg-blue-600 text-white shadow-md shadow-blue-900/40 snap-start';
                    btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    btn.className = 'whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium transition-all duration-200 border border-gray-700 bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-gray-200 snap-start';
                }
            });
        }

        async function loadBoard(board) {
            state.board = board;
            updateActiveTab(board);
            state.articles = [];
            state.nextPage = null;
            els.list.innerHTML = '';
            els.gal.innerHTML = '';
            
            if (board === 'BeautyGallery') {
                switchView('gallery');
                $('list-view-controls').classList.add('hidden');
                $('gallery-size-toggle-btn').classList.remove('hidden');
            } else {
                switchView('list');
                $('list-view-controls').classList.remove('hidden');
                $('gallery-size-toggle-btn').classList.add('hidden');
                renderSkeleton();
            }
            
            await fetchArticles();
        }

        async function fetchArticles() {
            if(state.loading) return;
            state.loading = true;
            els.loader.classList.remove('hidden');
            $('gallery-loading').classList.remove('hidden');

            try {
                let url = `/api/scraper?board=${state.board}`;
                if(state.nextPage) url += `&list_url=${encodeURIComponent(state.nextPage)}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                state.nextPage = data.prev_page_url;
                
                if(state.board === 'BeautyGallery') {
                    renderGallery(data.articles);
                } else {
                    renderList(data.articles);
                    fetchPreviews(data.articles);
                }
            } catch(e) {
                console.error(e);
                toast('載入失敗');
            } finally {
                state.loading = false;
                els.skel.classList.add('hidden');
                els.loader.classList.add('hidden');
                $('gallery-loading').classList.add('hidden');
            }
        }
        
        function loadMore() { if(state.nextPage) fetchArticles(); }

        function renderList(items) {
            const frag = document.createDocumentFragment();
            items.forEach(item => {
                if(!item.title) return;
                const div = document.createElement('div');
                div.className = `p-3 border-b border-gray-800 hover:bg-gray-900 transition-colors cursor-pointer flex gap-3 ${state.read.has(item.link)?'opacity-50':''}`;
                div.id = `art-${btoa(item.link).slice(0,10)}`;
                div.onclick = () => loadDetail(item);
                
                div.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <h3 class="font-bold text-[15px] leading-snug text-gray-200 line-clamp-2 mb-1">
                            ${state.board==='Hot'?`<span class="text-blue-400 mr-1">[${item.board}]</span>`:''}
                            ${item.title}
                            ${item.push_count?`<span class="ml-1 text-xs px-1.5 rounded-full ${getPushColor(item.push_count)} text-black font-bold">${item.push_count}</span>`:''}
                        </h3>
                        <div class="flex items-center text-xs text-gray-500 gap-2">
                            <span>${item.author}</span>
                            <span>•</span>
                            <span>${item.date}</span>
                        </div>
                        <p class="preview-text text-sm text-gray-400 mt-1 line-clamp-2 h-0 opacity-0 transition-all duration-300"></p>
                    </div>
                    <div class="thumb-box hidden w-20 h-20 rounded bg-gray-800 flex-shrink-0 bg-cover bg-center transition-opacity duration-500 opacity-0"></div>
                `;
                frag.appendChild(div);
            });
            els.list.appendChild(frag);
        }

        async function fetchPreviews(items) {
            const urls = items.map(i => i.link);
            for(let i=0; i<urls.length; i+=5) {
                const chunk = urls.slice(i, i+5);
                fetch('/api/previews', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({urls: chunk})
                }).then(r=>r.json()).then(res => {
                    res.forEach(d => {
                        const el = document.getElementById(`art-${btoa(d.link).slice(0,10)}`);
                        if(el && !d.error) {
                            if(d.snippet) {
                                const p = el.querySelector('.preview-text');
                                p.textContent = d.snippet;
                                p.classList.remove('h-0', 'opacity-0');
                            }
                            if(d.thumbnail) {
                                const t = el.querySelector('.thumb-box');
                                t.style.backgroundImage = `url(/api/scraper?proxy_url=${encodeURIComponent(d.thumbnail)})`;
                                t.classList.remove('hidden', 'opacity-0');
                            }
                        }
                    });
                });
            }
        }

        async function loadDetail(item) {
            state.read.add(item.link);
            localStorage.setItem('read_v2', JSON.stringify([...state.read]));
            document.getElementById(`art-${btoa(item.link).slice(0,10)}`)?.classList.add('opacity-50');

            switchView('detail');
            els.detail.innerHTML = '<div class="flex justify-center py-20"><div class="loader w-8 h-8 rounded-full border-2 border-t-transparent border-blue-500"></div></div>';
            els.title.textContent = item.title;
            state.currArt = item;
            updateFavIcons();

            try {
                const res = await fetch(`/api/scraper?article_url=${encodeURIComponent(item.link)}`);
                const data = await res.json();
                state.imgs = data.images;
                
                const contentHTML = processContent(data.content);
                const pushesHTML = data.pushes.map(p => `
                    <div class="push">
                        <span class="push-tag ${p.tag==='推'?'push-tag-推':p.tag==='噓'?'push-tag-噓':'push-tag-→'}">${p.tag}</span>
                        <span class="push-userid text-blue-400">${p.user}</span>
                        <span class="push-content">${linkify(p.content.replace(/^:/,''))}</span>
                    </div>
                `).join('');

                els.detail.innerHTML = `
                    <div class="text-gray-400 text-sm mb-4 pb-2 border-b border-gray-800">
                        <div class="flex justify-between">
                            <span class="text-blue-400 font-bold">${data.author_full}</span>
                            <span>${data.formatted_timestamp}</span>
                        </div>
                        <h1 class="text-xl font-bold text-gray-100 mt-2 leading-relaxed">${item.title}</h1>
                    </div>
                    <div class="text-lg leading-relaxed text-gray-300 break-words space-y-4" id="main-text">
                        ${contentHTML}
                    </div>
                    <div class="mt-8 pt-4 border-t border-gray-800 space-y-1">
                        ${pushesHTML}
                    </div>
                `;

                els.detail.querySelectorAll('img.art-img').forEach((img, idx) => {
                    img.onclick = () => openModal(idx);
                });

            } catch(e) {
                els.detail.innerHTML = '<p class="text-center text-red-500 mt-10">載入失敗</p>';
            }
        }
        
        function renderGallery(items) {
            const frag = document.createDocumentFragment();
            items.forEach(item => {
                const a = document.createElement('a');
                a.className = 'gallery-item';
                a.dataset.link = item.article.link;
                const imgUrl = `/api/scraper?proxy_url=${encodeURIComponent(item.preview_image)}`;
                
                a.innerHTML = `<img src="${imgUrl}" loading="lazy" />
                               <div class="fav-overlay absolute top-2 right-2 bg-black/60 rounded-full p-1 hidden"><svg class="w-5 h-5 text-pink-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg></div>`;
                a.onclick = () => {
                    state.currArt = item.article;
                    state.imgs = item.all_images;
                    openModal(item.all_images.indexOf(item.preview_image));
                };
                frag.appendChild(a);
            });
            els.gal.appendChild(frag);
            updateFavIcons();
        }

        function processContent(text) {
            const urlRegex = /(https?:\/\/[^\s<>"]+)/g;
            return text.replace(urlRegex, (url) => {
                const clean = url.split('&')[0];
                if(clean.match(/\.(jpg|jpeg|png|gif|webp)$/i) || clean.includes('imgur') || clean.includes('upload.cc')) {
                    return `<img src="/api/scraper?proxy_url=${encodeURIComponent(clean)}" class="art-img rounded-lg my-3 w-full max-w-full cursor-pointer bg-gray-800 min-h-[150px]" loading="lazy" />`;
                }
                if(clean.match(/youtube\.com|youtu\.be/)) {
                    const vid = clean.match(/v=([a-zA-Z0-9_-]+)/)?.[1] || clean.split('/').pop();
                    return `<div class="youtube-container"><iframe src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe></div>`;
                }
                return `<a href="${url}" target="_blank" class="text-blue-400 break-all hover:underline">${url}</a>`;
            }).replace(/\n/g, '<br>');
        }
        
        function linkify(text) { return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-400">$1</a>'); }

        function switchView(v) {
            Object.values(els.views).forEach(el => el.classList.add('hidden'));
            els.views[v].classList.remove('hidden');
            state.view = v;
            
            if(v === 'detail') {
                els.header.querySelector('.overflow-x-auto').classList.add('hidden'); // 隱藏 Tabs
                els.title.classList.remove('hidden');
                $('detail-view-controls').classList.remove('hidden');
                $('floating-back-btn').classList.remove('hidden');
                $('list-view-controls').classList.add('hidden');
                $('auth-container').classList.add('hidden');
            } else {
                els.header.querySelector('.overflow-x-auto').classList.remove('hidden'); // 顯示 Tabs
                els.title.classList.add('hidden');
                $('detail-view-controls').classList.add('hidden');
                $('floating-back-btn').classList.add('hidden');
                $('auth-container').classList.remove('hidden');
                
                if (v === 'list') {
                     $('list-view-controls').classList.remove('hidden');
                } else if (v === 'gallery') {
                     $('list-view-controls').classList.add('hidden');
                }
            }
        }

        function goBack() {
            if(state.view === 'detail') {
                switchView(state.board === 'BeautyGallery' ? 'gallery' : 'list');
            }
        }
        
        function openModal(idx) {
            state.imgIdx = idx;
            els.modal.classList.remove('hidden');
            renderModalImg();
        }
        function closeModal() {
            els.modal.classList.add('hidden');
            if(state.zoom) { state.zoom.destroy(); state.zoom = null; }
        }
        function chgImg(dir) {
            const newIdx = state.imgIdx + dir;
            if(newIdx >= 0 && newIdx < state.imgs.length) {
                state.imgIdx = newIdx;
                renderModalImg();
            }
        }
        function renderModalImg() {
            if(state.zoom) { state.zoom.destroy(); state.zoom = null; }
            const url = state.imgs[state.imgIdx];
            els.zoomTgt.innerHTML = `<div class="loader w-10 h-10 border-4 border-t-transparent border-white rounded-full"></div>`;
            
            const img = new Image();
            img.src = `/api/scraper?proxy_url=${encodeURIComponent(url)}`;
            img.onload = () => {
                els.zoomTgt.innerHTML = '';
                els.zoomTgt.appendChild(img);
                state.zoom = new PinchZoom.default(els.zoomTgt, {minZoom: 1, maxZoom: 5});
            };
            
            $('image-prev-btn').disabled = state.imgIdx === 0;
            $('image-next-btn').disabled = state.imgIdx === state.imgs.length - 1;
            updateFavIcons();
        }
        async function downloadImg() {
            const url = state.imgs[state.imgIdx];
            const a = document.createElement('a');
            a.href = `/api/scraper?proxy_url=${encodeURIComponent(url)}`;
            a.download = 'ptt-image.jpg';
            a.click();
        }

        async function toggleFav() {
            if(!uid) return toast('請先登入');
            if(!state.currArt) return;
            const ref = doc(db, 'users', uid, 'favorites', btoa(state.currArt.link));
            const isFav = state.favorites.some(f => f.link === state.currArt.link);
            
            if(isFav) {
                await deleteDoc(ref);
                toast('已取消收藏');
            } else {
                await setDoc(ref, state.currArt);
                toast('已加入收藏');
            }
        }
        function toggleFavModal() { toggleFav(); }
        
        function updateFavIcons() {
            const isFav = state.currArt && state.favorites.some(f => f.link === state.currArt.link);
            const icon = $('header-favorite-btn').querySelector('svg');
            icon.setAttribute('fill', isFav ? '#ec4899' : 'none');
            icon.classList.toggle('text-pink-500', isFav);
            
            const modalIcon = $('favorite-from-modal-btn').querySelector('svg');
            modalIcon.setAttribute('fill', isFav ? 'currentColor' : 'none');
            
            document.querySelectorAll('.gallery-item').forEach(el => {
                const link = el.dataset.link;
                const overlay = el.querySelector('.fav-overlay');
                if(state.favorites.some(f=>f.link===link)) overlay.classList.remove('hidden');
                else overlay.classList.add('hidden');
            });
        }

        function toggleShowFavs() {
             if(!uid) return toast('請先登入');
             const btn = $('toggle-favorites-btn');
             const isShowing = btn.classList.contains('text-pink-500');
             
             if(!isShowing) {
                 btn.classList.add('text-pink-500');
                 $('fav-icon-outline').classList.add('hidden');
                 $('fav-icon-solid').classList.remove('hidden');
                 renderList(state.favorites);
             } else {
                 btn.classList.remove('text-pink-500');
                 $('fav-icon-outline').classList.remove('hidden');
                 $('fav-icon-solid').classList.add('hidden');
                 loadBoard(state.board);
             }
        }

        function toggleGalSize() {
            const sizes = ['sm', 'md', 'lg'];
            state.galSize = sizes[(sizes.indexOf(state.galSize)+1)%3];
            localStorage.setItem('gal_size', state.galSize);
            applyGalSize();
        }
        function applyGalSize() {
            els.gal.className = `flex-grow overflow-y-auto p-1 size-${state.galSize}`;
        }
        
        function renderSkeleton() {
            els.skel.classList.remove('hidden');
            els.skel.innerHTML = Array(6).fill(0).map(() => 
                `<div class="flex gap-3 p-3 animate-pulse border-b border-gray-800">
                    <div class="flex-grow space-y-2">
                        <div class="h-5 bg-gray-800 rounded w-3/4"></div>
                        <div class="h-3 bg-gray-800 rounded w-1/4"></div>
                        <div class="h-10 bg-gray-800 rounded w-full mt-2"></div>
                    </div>
                    <div class="w-20 h-20 bg-gray-800 rounded"></div>
                </div>`
            ).join('');
        }
        function getPushColor(c) {
            if(c === '爆') return 'bg-red-500';
            if(typeof c === 'number' && c > 50) return 'bg-yellow-400';
            if(typeof c === 'number' && c > 10) return 'bg-green-400';
            return 'bg-gray-400';
        }
        function toast(msg) {
            const t = $('toast-notification');
            $('toast-message').textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        function throttle(func, limit) {
            let lastFunc;
            let lastRan;
            return function() {
                const context = this;
                const args = arguments;
                if (!lastRan) {
                    func.apply(context, args);
                    lastRan = Date.now();
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(function() {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(context, args);
                            lastRan = Date.now();
                        }
                    }, limit - (Date.now() - lastRan));
                }
            }
        }
    </script>
</body>
</html>