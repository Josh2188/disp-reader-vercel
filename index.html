<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PTT 行動版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-black text-gray-800 dark:text-gray-200">

    <div class="max-w-md mx-auto bg-white dark:bg-gray-900 min-h-screen shadow-lg">
        <div id="list-view">
            <header class="bg-gray-50 dark:bg-gray-800 shadow-sm sticky top-0 z-20 p-3">
                <div class="flex items-center gap-3">
                    <select id="board-selector" class="bg-gray-200 dark:bg-gray-700 border-none text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none flex-shrink-0">
                        <svg id="theme-icon-light" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <svg id="theme-icon-dark" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    </button>
                </div>
            </header>
            <main id="articles-list" class="divide-y divide-gray-200 dark:divide-gray-700"></main>
            <div id="list-loader" class="flex justify-center items-center py-20"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-16 w-16"></div></div>
            <div id="list-error" class="text-center py-20 text-red-500 hidden"><p id="list-error-text"></p></div>
            <div id="pagination" class="flex justify-center items-center my-4 space-x-4 hidden"><button id="prev-page" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">舊文章</button><button id="next-page" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">最新頁</button></div>
        </div>

        <div id="detail-view" class="hidden h-screen flex flex-col">
            <header class="bg-blue-600 dark:bg-blue-800 text-white shadow-md sticky top-0 z-20 p-3 flex items-center gap-3">
                <button id="back-button" class="p-2 rounded-full hover:bg-blue-500 dark:hover:bg-blue-700"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="font-bold text-lg truncate">PTT 行動版</h2>
            </header>
            <main id="detail-content" class="flex-grow p-4 overflow-y-auto no-scrollbar"></main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const listView = document.getElementById('list-view');
            const detailView = document.getElementById('detail-view');
            const articlesList = document.getElementById('articles-list');
            const listLoader = document.getElementById('list-loader');
            const listError = document.getElementById('list-error');
            const listErrorText = document.getElementById('list-error-text');
            const pagination = document.getElementById('pagination');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const boardSelector = document.getElementById('board-selector');
            const backButton = document.getElementById('back-button');
            const detailContent = document.getElementById('detail-content');
            
            let prevPageUrl = null;
            const TOP_BOARDS = { "Gossiping": "八卦", "C_Chat": "希洽", "Stock": "股票", "Lifeismoney": "省錢", "MobileComm": "手機", "NBA": "NBA", "Baseball": "棒球", "Boy-Girl": "男女", "Tech_Job": "科技業", "Car": "汽車", "Beauty": "表特", "HatePolitics": "政黑", "KoreaStar": "韓星", "movie": "電影", "e-shopping": "網購" };

            for (const board_en in TOP_BOARDS) {
                const option = document.createElement('option');
                option.value = board_en;
                option.textContent = `${TOP_BOARDS[board_en]}`;
                boardSelector.appendChild(option);
            }

            const themeToggle = document.getElementById('theme-toggle');
            const themeIconLight = document.getElementById('theme-icon-light');
            const themeIconDark = document.getElementById('theme-icon-dark');
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    themeIconLight.classList.remove('hidden');
                    themeIconDark.classList.add('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    themeIconLight.classList.add('hidden');
                    themeIconDark.classList.remove('hidden');
                }
            };
            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(currentTheme);
            themeToggle.addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });

            function createListItem(article) {
                const item = document.createElement('div');
                item.className = 'flex items-center p-3 gap-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer';
                
                let thumbnailHTML = '';
                if (article.thumbnail) {
                    thumbnailHTML = `
                        <div class="w-20 h-20 bg-gray-200 dark:bg-gray-700 rounded-lg flex-shrink-0 flex items-center justify-center">
                            <img src="${article.thumbnail}" alt="thumbnail" class="w-full h-full object-cover rounded-lg" onerror="this.style.display='none';">
                        </div>
                    `;
                }

                item.innerHTML = `
                    ${thumbnailHTML}
                    <div class="flex flex-col overflow-hidden flex-grow">
                        <h3 class="font-bold text-base leading-tight text-gray-900 dark:text-white">${article.title}</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${article.author} - ${article.date}</p>
                    </div>
                `;
                item.addEventListener('click', () => showDetailView(article));
                return item;
            }

            async function loadArticles(board, url = null) {
                listLoader.classList.remove('hidden');
                articlesList.innerHTML = '';
                listError.classList.add('hidden');
                pagination.classList.add('hidden');

                try {
                    const apiUrl = url ? `/api/scraper?board=${board}&list_url=${encodeURIComponent(url)}` : `/api/scraper?board=${board}`;
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `請求失敗`);
                    
                    const filteredArticles = data.articles.filter(a => !a.title.includes('[公告]'));
                    filteredArticles.forEach(article => articlesList.appendChild(createListItem(article)));

                    listLoader.classList.add('hidden');
                    pagination.classList.remove('hidden');
                    
                    prevPageUrl = data.prev_page_url;
                    prevPageBtn.disabled = !prevPageUrl;

                } catch (error) {
                    listLoader.classList.add('hidden');
                    listErrorText.textContent = error.message;
                    listError.classList.remove('hidden');
                }
            }
            
            function showListView() {
                detailView.classList.add('hidden');
                listView.classList.remove('hidden');
            }

            async function showDetailView(article) {
                listView.classList.add('hidden');
                detailView.classList.remove('hidden');
                detailContent.innerHTML = '<div class="flex justify-center items-center py-20"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-16 w-16"></div></div>';

                try {
                    const response = await fetch(`/api/scraper?article_url=${encodeURIComponent(article.link)}`);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || '無法載入內文');

                    let imagesHTML = '';
                    data.images.forEach(imgUrl => {
                        imagesHTML += `<img src="${imgUrl}" alt="文章圖片" class="my-4 rounded-lg">`;
                    });

                    detailContent.innerHTML = `
                        <div class="bg-blue-100 dark:bg-blue-900/50 p-3 rounded-lg text-sm mb-4">
                            <p><strong>看板:</strong> ${article.board}</p>
                            <p><strong>作者:</strong> ${data.author_full}</p>
                            <p><strong>標題:</strong> ${article.title}</p>
                            <p><strong>時間:</strong> ${data.timestamp}</p>
                        </div>
                        <div class="text-base leading-relaxed whitespace-pre-wrap break-words">${data.content}</div>
                        <div class="mt-4">${imagesHTML}</div>
                    `;

                } catch (error) {
                    detailContent.innerHTML = `<p class="text-red-500 font-bold">${error.message}</p>`;
                }
            }
            
            boardSelector.addEventListener('change', () => loadArticles(boardSelector.value));
            prevPageBtn.addEventListener('click', () => { if(prevPageUrl) loadArticles(boardSelector.value, prevPageUrl); });
            nextPageBtn.addEventListener('click', () => loadArticles(boardSelector.value));
            backButton.addEventListener('click', showListView);

            loadArticles(boardSelector.value);
        });
    </script>
</body>
</html>
