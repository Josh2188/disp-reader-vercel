<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTT 行動版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pinch-zoom-js@2.3.4/dist/pinch-zoom.umd.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .glassmorphism { background-color: rgba(255, 255, 255, 0.7); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); }
        .dark .glassmorphism { background-color: rgba(17, 24, 39, 0.7); }
        #image-modal.hidden, #image-modal-controls.hidden { display: none; }
        .pinch-zoom-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: grab; }
        .pinch-zoom-container.is-dragging { cursor: grabbing; }
        .pinch-zoom-container img { max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none; }
        .image-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.3); color: white; border: none; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.3s ease; z-index: 61; }
        #image-modal:hover .image-nav-btn { opacity: 1; }
        .image-nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }
        #image-prev-btn { left: 16px; }
        #image-next-btn { right: 16px; }
        #toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); transition: bottom 0.5s ease-in-out; z-index: 100; }
        #toast-notification.show { bottom: 20px; }
        .thumbnail-container {
            width: 96px; height: 96px; flex-shrink: 0; overflow: hidden;
            border-radius: 0.5rem; background-color: #e5e7eb;
        }
        .dark .thumbnail-container { background-color: #374151; }
        .thumbnail-container img { width: 100%; height: 100%; object-fit: cover; }
        #retry-indicator {
            position: fixed; bottom: 1rem; right: 1rem;
            background-color: rgba(239, 68, 68, 0.8); color: white;
            padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem;
            z-index: 50; opacity: 0; transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        #retry-indicator.show { opacity: 1; }
        /* === 修改後推文樣式 === */
        .push { display: flex; flex-wrap: wrap; margin-bottom: 0.75rem; font-size: 0.875rem; line-height: 1.5; }
        .push-main { display: flex; width: 100%; align-items: baseline; }
        .push-tag { flex-shrink: 0; width: 2rem; font-weight: 600; text-align: center; }
        .push-tag-推 { color: #22c55e; }
        .push-tag-噓 { color: #ef4444; }
        .push-tag-→ { color: #6b7280; }
        .dark .push-tag-→ { color: #9ca3af; }
        .push-userid { font-weight: 600; margin-right: 0.5rem; color: #3b82f6; }
        .dark .push-userid { color: #60a5fa; }
        .push-content { flex-grow: 1; word-break: break-all; }
        .push-time { width: 100%; text-align: right; font-size: 0.75rem; color: #9ca3af; margin-top: 0.125rem; }
        .dark .push-time { color: #6b7280; }
        /* === 媒體樣式 === */
        .youtube-container {
            position: relative; padding-bottom: 56.25%; height: 0;
            overflow: hidden; max-width: 100%; background: #000; margin: 1rem 0; border-radius: 0.5rem;
        }
        .youtube-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .youtube-thumbnail { cursor: pointer; position: relative; display: block; }
        .youtube-thumbnail::after {
            content: '▶'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 3rem; color: white;
            background-color: rgba(0,0,0,0.5); width: 60px; height: 42px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px; line-height: 42px; padding-left: 5px;
        }
        .article-image { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-black">

    <div id="app-container" class="max-w-md mx-auto bg-white dark:bg-black text-gray-900 dark:text-gray-100 min-h-screen shadow-lg flex flex-col">
        <header id="main-header" class="bg-gray-50/80 dark:bg-gray-900/80 shadow-sm sticky top-0 z-20 p-3 glassmorphism">
            <div class="flex items-center gap-2">
                <button id="header-back-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 hidden"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <select id="board-selector" class="bg-gray-200 dark:bg-gray-700 border-none text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                <h2 id="header-title" class="font-bold text-lg truncate flex-grow hidden"></h2>
                
                <div id="list-view-controls" class="flex-shrink-0 flex items-center gap-1">
                    <button id="toggle-sort-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-1" title="切換排序"><svg id="sort-time-icon" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><svg id="sort-hot-icon" class="h-5 w-5 hidden text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.362-3.797A8.333 8.333 0 0112 6c1.23 0 2.398.256 3.362.714z" /></svg></button>
                    <div id="user-controls" class="hidden items-center gap-1">
                        <button id="toggle-favorites-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="我的最愛"><svg id="fav-icon-outline" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg><svg id="fav-icon-solid" class="h-5 w-5 hidden text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></button>
                        <button id="clear-cache-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="清除快取"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></button>
                    </div>
                    <!-- === 恢復列表頁的全螢幕按鈕 === -->
                    <button id="fullscreen-toggle-list" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="全螢幕">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>
                    </button>
                </div>
                <div id="auth-container" class="flex-shrink-0">
                     <button id="google-login-btn" class="flex items-center justify-center gap-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 36.49 44 30.856 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>Google 登入</button>
                    <div id="user-info" class="hidden items-center"><div class="relative ml-auto"><button id="avatar-btn"><img id="user-avatar" class="w-8 h-8 rounded-full cursor-pointer" src="" alt="User Avatar"></button><div id="logout-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 z-50 ring-1 ring-black ring-opacity-5"><button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700">登出</button></div></div></div>
                </div>
                <div id="detail-view-controls" class="flex-shrink-0 flex items-center gap-2 hidden">
                    <button id="header-dislike-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold py-1 px-3 text-sm rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="不喜歡這篇文章">Dislike</button>
                    <button id="header-favorite-btn" class="p-2 rounded-full hover:bg-pink-100 dark:hover:bg-pink-900/50 transition-colors" title="加入/移除我的最愛"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg></button>
                    <button id="fullscreen-toggle-detail" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="全螢幕"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg></button>
                </div>
            </div>
        </header>

        <div class="flex-grow relative">
            <div id="list-view" class="absolute inset-0 flex flex-col">
                <div id="skeleton-container" class="flex-grow divide-y divide-gray-200 dark:divide-gray-700 overflow-y-auto no-scrollbar"></div>
                <main id="articles-list" class="flex-grow divide-y divide-gray-200 dark:divide-gray-700 overflow-y-auto no-scrollbar hidden"></main>
                <div id="infinite-loader" class="flex justify-center items-center py-4 hidden"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div></div>
                <div id="list-error" class="text-center py-20 text-red-500 hidden"><p id="list-error-text"></p></div>
            </div>
            <div id="detail-view" class="absolute inset-0 hidden"><main id="detail-content" class="h-full overflow-y-auto no-scrollbar p-4"></main></div>
        </div>
    </div>

    <div id="image-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-2 glassmorphism">
        <div id="pinch-zoom-target" class="pinch-zoom-container"></div>
        <button id="image-prev-btn" class="image-nav-btn"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
        <button id="image-next-btn" class="image-nav-btn"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
    </div>
    <div id="image-modal-controls" class="hidden fixed top-0 right-0 m-4 flex gap-2 z-[60]">
        <button id="download-btn" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 focus:outline-none"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
        <button id="close-modal-btn" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 focus:outline-none"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
    </div>
    <button id="floating-back-btn" class="hidden fixed bottom-5 left-1/2 -translate-x-1.2 z-50 p-3 bg-black/40 text-white rounded-full transition-opacity duration-300 opacity-0 hover:bg-black/60"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
    <div id="toast-notification" class="bg-gray-800 text-white text-sm py-2 px-4 rounded-full shadow-lg"><p id="toast-message"></p></div>
    <div id="retry-indicator" class=""><p id="retry-message"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = {
              apiKey: "AIzaSyBVK9oYxwz7Wrg4d5dz1eNQyRTigDtHxbQ",
              authDomain: "my-english-learning-app-5d864.firebaseapp.com",
              projectId: "my-english-learning-app-5d864",
              storageBucket: "my-english-learning-app-5d864.appspot.com",
              messagingSenderId: "748913890079",
              appId: "1:748913890079:web:dad0719760593d43e7962a"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            let userId = null;
            let unsubscribeFavorites = null, unsubscribeDisliked = null;

            const cache = {
                get(key) {
                    const itemStr = localStorage.getItem(key);
                    if (!itemStr) return null;
                    try {
                        const item = JSON.parse(itemStr);
                        if (new Date().getTime() > item.expiry) {
                            localStorage.removeItem(key); return null;
                        }
                        return item.data;
                    } catch (e) { return null; }
                },
                set(key, data) {
                    const item = {
                        data: data,
                        expiry: new Date().getTime() + 7 * 24 * 60 * 60 * 1000,
                    };
                    localStorage.setItem(key, JSON.stringify(item));
                }
            };

            let state = {
                currentBoard: 'Gossiping', prevPageUrl: null, isLoading: false, 
                currentView: 'list', currentArticle: null, favorites: [], 
                dislikedArticles: [], readArticles: new Set(JSON.parse(localStorage.getItem('readArticles')) || []),
                pinchZoomInstance: null, inactivityTimer: null, currentArticleImages: [],
                currentImageIndex: 0, allArticles: [], sortBy: 'time', 
                viewingFavorites: false, infiniteScrollRetries: 0,
            };
            const MAX_RETRIES = 10; // === 修改：增加重試次數 ===

            const el = id => document.getElementById(id);
            const docEl = document.documentElement;
            const listView = el('list-view'), detailView = el('detail-view'), articlesList = el('articles-list');
            const skeletonContainer = el('skeleton-container'), infiniteLoader = el('infinite-loader'), listError = el('list-error');
            const listErrorText = el('list-error-text'), boardSelector = el('board-selector'), headerBackBtn = el('header-back-btn');
            const headerTitle = el('header-title'), detailContent = el('detail-content'), floatingBackBtn = el('floating-back-btn');
            const imageModal = el('image-modal'), imageModalControls = el('image-modal-controls'), imagePrevBtn = el('image-prev-btn');
            const imageNextBtn = el('image-next-btn'), pinchZoomTarget = el('pinch-zoom-target'), downloadBtn = el('download-btn');
            const closeModalBtn = el('close-modal-btn'), clearCacheBtn = el('clear-cache-btn'), toggleFavoritesBtn = el('toggle-favorites-btn');
            const favIconOutline = el('fav-icon-outline'), favIconSolid = el('fav-icon-solid'), toggleSortBtn = el('toggle-sort-btn');
            const sortTimeIcon = el('sort-time-icon'), sortHotIcon = el('sort-hot-icon'), listViewControls = el('list-view-controls');
            const detailViewControls = el('detail-view-controls');
            const googleLoginBtn = el('google-login-btn'), userInfo = el('user-info'), userAvatar = el('user-avatar');
            const logoutBtn = el('logout-btn'), userControls = el('user-controls'), avatarBtn = el('avatar-btn');
            const logoutDropdown = el('logout-dropdown'), headerDislikeBtn = el('header-dislike-btn');
            const retryIndicator = el('retry-indicator'), retryMessage = el('retry-message');
            const fullscreenToggleList = el('fullscreen-toggle-list');
            const fullscreenToggleDetail = el('fullscreen-toggle-detail');
            
            const TOP_BOARDS = { "Gossiping": "八卦", "Beauty": "表特", "C_Chat": "希洽", "Stock": "股票", "Lifeismoney": "省錢", "MobileComm": "手機", "NBA": "NBA", "Baseball": "棒球", "Boy-Girl": "男女", "Tech_Job": "科技業", "Car": "汽車", "HatePolitics": "政黑", "KoreaStar": "韓星", "movie": "電影", "e-shopping": "網購" };

            onAuthStateChanged(auth, user => {
                if (unsubscribeFavorites) unsubscribeFavorites();
                if (unsubscribeDisliked) unsubscribeDisliked();
                if (user && !user.isAnonymous) {
                    userId = user.uid;
                    googleLoginBtn.classList.add('hidden');
                    userInfo.classList.remove('hidden'); userControls.classList.remove('hidden');
                    userAvatar.src = user.photoURL;
                    unsubscribeFavorites = onSnapshot(collection(db, 'users', userId, 'favorites'), snap => {
                        state.favorites = snap.docs.map(d => d.data());
                        if (state.viewingFavorites) renderAndSortArticles();
                        if(state.currentView === 'detail' && state.currentArticle) updateFavoriteIcon(isFavorite(state.currentArticle.link));
                    });
                    unsubscribeDisliked = onSnapshot(collection(db, 'users', userId, 'disliked_articles'), snap => {
                        state.dislikedArticles = snap.docs.map(d => d.data());
                        renderAndSortArticles();
                    });
                } else {
                    userId = user ? user.uid : null;
                    googleLoginBtn.classList.remove('hidden');
                    userInfo.classList.add('hidden'); userControls.classList.add('hidden');
                    state.favorites = []; state.dislikedArticles = [];
                    if (!user) signInAnonymously(auth).catch(e => console.error("匿名登入失敗:", e));
                }
            });

            const showToast = message => { const t = el('toast-notification'); el('toast-message').textContent = message; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };
            googleLoginBtn.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); showToast(`登入成功！`); } catch (e) { showToast('Google 登入失敗'); } });
            logoutBtn.addEventListener('click', async () => { try { await signOut(auth); showToast('您已成功登出'); } catch (e) { showToast('登出時發生錯誤'); } });
            avatarBtn.addEventListener('click', e => { e.stopPropagation(); logoutDropdown.classList.toggle('hidden'); });
            window.addEventListener('click', () => { if (!logoutDropdown.classList.contains('hidden')) logoutDropdown.classList.add('hidden'); });

            const saveReadArticles = () => localStorage.setItem('readArticles', JSON.stringify([...state.readArticles]));
            const isFavorite = link => state.favorites.some(fav => fav.link === link);

            // === 新增：媒體與連結轉換函式 ===
            function linkifyAndMediafy(text) {
                if (!text) return '';
                const urlRegex = /(https?:\/\/[^\s<>"]+)/g;
                const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                const imageRegex = /\.(jpg|jpeg|png|gif|avif|webp)($|\?)/i;

                const escapeHTML = str => str.replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag));
                
                // 先將純文字中的換行符號轉換為 <br>
                let processedText = escapeHTML(text).replace(/\n/g, '<br>');

                return processedText.replace(urlRegex, url => {
                    const cleanUrl = url.split('&amp;')[0]; // 處理被 escape 的 & 符號
                    const ytMatch = cleanUrl.match(youtubeRegex);
                    if (ytMatch) {
                        const videoId = ytMatch[1];
                        return `<a href="${cleanUrl}" class="youtube-thumbnail" data-youtube-id="${videoId}"><img src="https://i.ytimg.com/vi/${videoId}/hqdefault.jpg" class="my-2 rounded-lg max-w-full h-auto" loading="lazy"></a>`;
                    }
                    if (imageRegex.test(cleanUrl)) {
                        const proxiedUrl = `/api/scraper?proxy_url=${encodeURIComponent(cleanUrl)}`;
                        return `<img src="${proxiedUrl}" alt="圖片" class="article-image my-2 rounded-lg max-w-full h-auto" data-original-url="${cleanUrl}">`;
                    }
                    return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-500 dark:text-blue-400 hover:underline">${cleanUrl}</a>`;
                });
            }
            
            function updateHeader() {
                const isDetail = state.currentView === 'detail';
                boardSelector.classList.toggle('hidden', isDetail);
                listViewControls.classList.toggle('hidden', isDetail);
                detailViewControls.classList.toggle('hidden', !isDetail);
                headerBackBtn.classList.toggle('hidden', !isDetail);
                headerTitle.classList.toggle('hidden', !isDetail);
                el('auth-container').classList.toggle('hidden', isDetail);
                if (isDetail && state.currentArticle) {
                    headerTitle.textContent = state.currentArticle.title;
                    updateFavoriteIcon(isFavorite(state.currentArticle.link));
                }
            }
            
            function createSkeletonItem() { return `<div class="flex items-start p-3 gap-3 animate-pulse"><div class="flex flex-col overflow-hidden flex-grow"><div class="h-5 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mb-3"></div><div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-full"></div><div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-5/6 mt-1"></div></div><div class="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-lg flex-shrink-0"></div></div>`; }
            function showSkeleton() { skeletonContainer.innerHTML = Array(8).fill(createSkeletonItem()).join(''); skeletonContainer.classList.remove('hidden'); articlesList.classList.add('hidden'); }
            function hideSkeleton() { skeletonContainer.classList.add('hidden'); articlesList.classList.remove('hidden'); }
            function updateFavoriteIcon(isFav) { if(auth.currentUser && !auth.currentUser.isAnonymous) headerFavoriteBtn.querySelector('svg').classList.toggle('fill-pink-500', isFav); }

            function renderArticles(articleData) {
                const fragment = document.createDocumentFragment();
                articleData.forEach(article => fragment.appendChild(createListItem(article)));
                articlesList.innerHTML = '';
                articlesList.appendChild(fragment);
            }
            
            function getPushCountBgClass(c) { if (c === '爆') return 'bg-red-500'; if (typeof c === 'number' && c >= 50) return 'bg-yellow-500'; if (typeof c === 'number' && c >= 10) return 'bg-green-500'; if (typeof c === 'string' && c.startsWith('X')) return 'bg-gray-500'; return 'bg-blue-500'; }

            function createListItem(article) {
                const item = document.createElement('div');
                item.className = `flex items-start p-3 gap-3 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer ${state.readArticles.has(article.link) ? 'opacity-60' : ''}`;
                item.dataset.link = article.link;
                const pushHTML = article.push_count ? `<span class="ml-2 inline-block ${getPushCountBgClass(article.push_count)} text-white text-xs font-semibold px-2 py-0.5 rounded-full">${article.push_count}</span>` : '';
                const timestampText = article.formatted_timestamp ? `${article.author} - ${article.formatted_timestamp}` : `${article.author} - ${article.date}`;
                const snippetText = article.snippet || '';
                let thumbnailHTML = '';
                if (article.thumbnail) {
                    const proxiedImageUrl = `/api/scraper?proxy_url=${encodeURIComponent(article.thumbnail)}`;
                    const imageHTML = `<img src="${proxiedImageUrl}" alt="thumbnail" loading="lazy" onerror="this.closest('.thumbnail-container').style.display='none';">`;
                    thumbnailHTML = `<div data-thumbnail-for="${article.link}" class="thumbnail-container">${imageHTML}</div>`;
                }
                item.innerHTML = `
                    <div class="flex flex-col overflow-hidden flex-grow">
                        <h3 class="font-bold text-base leading-tight line-clamp-2 text-gray-900 dark:text-blue-300">${article.title}${pushHTML}</h3>
                        <p data-timestamp-for="${article.link}" class="text-xs text-gray-500 dark:text-gray-400 mt-1 truncate">${timestampText}</p>
                        <p data-snippet-for="${article.link}" class="text-sm text-gray-600 dark:text-gray-300 mt-1 line-clamp-2">${snippetText}</p>
                    </div>
                    ${thumbnailHTML}`;
                item.addEventListener('click', () => {
                    const a = state.allArticles.find(a => a.link === article.link) || state.favorites.find(a => a.link === article.link);
                    if (a) showDetailView(a);
                });
                return item;
            }
            
            function updatePreviewsUI(previews) {
                previews.forEach(previewData => {
                    const articleInState = state.allArticles.find(a => a.link === previewData.link);
                    if (articleInState) {
                        Object.assign(articleInState, previewData);
                        const existingItem = articlesList.querySelector(`[data-link="${previewData.link}"]`);
                        if (existingItem) {
                            const newItem = createListItem(articleInState);
                            existingItem.replaceWith(newItem);
                        }
                    }
                });
            }

            async function fetchPreviewsInChunks(articles) {
                const articlesToFetch = articles.filter(a => typeof a.snippet === 'undefined');
                if (articlesToFetch.length === 0) return;
                const CHUNK_SIZE = 5;
                const articleLinks = articlesToFetch.map(a => a.link);
                for (let i = 0; i < articleLinks.length; i += CHUNK_SIZE) {
                    const chunk = articleLinks.slice(i, i + CHUNK_SIZE);
                    if (chunk.length === 0) continue;
                    try {
                        const res = await fetch('/api/previews', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ urls: chunk })
                        });
                        if (!res.ok) continue;
                        updatePreviewsUI(await res.json());
                    } catch (error) { console.error(`批次預覽錯誤:`, error); }
                }
            }
            
            async function loadArticles(board, url = null, append = false) {
                if (state.isLoading) return;
                state.isLoading = true;
                listError.classList.add('hidden');

                const listUrl = url || `https://www.ptt.cc/bbs/${board}/index.html`;
                const cacheKey = `ptt-cache-${board}`;

                if (!append) {
                    articlesList.innerHTML = '';
                    const cachedData = cache.get(cacheKey);
                    if (cachedData && cachedData.articles) {
                        state.allArticles = cachedData.articles;
                        state.prevPageUrl = cachedData.prevPageUrl;
                        renderAndSortArticles();
                        fetchPreviewsInChunks(state.allArticles);
                    } else {
                        showSkeleton();
                    }
                } else {
                    infiniteLoader.classList.remove('hidden');
                }

                try {
                    const res = await fetch(`/api/scraper?board=${board}&list_url=${encodeURIComponent(listUrl)}`);
                    if (!res.ok) throw new Error(`請求失敗: ${res.status}`);
                    const listData = await res.json();
                    
                    if (append) {
                        state.infiniteScrollRetries = 0;
                        retryIndicator.classList.remove('show');
                    }
                    
                    const newArticles = listData.articles.filter(a => a.title && !a.title.includes('[公告]'));
                    if (append) {
                        const existingLinks = new Set(state.allArticles.map(a => a.link));
                        const uniqueNewArticles = newArticles.filter(a => !existingLinks.has(a.link));
                        state.allArticles.push(...uniqueNewArticles);
                    } else {
                        state.allArticles = newArticles;
                    }
                    
                    state.prevPageUrl = listData.prev_page_url;
                    renderAndSortArticles();
                    fetchPreviewsInChunks(newArticles);

                    if (!append) cache.set(cacheKey, { articles: state.allArticles, prevPageUrl: state.prevPageUrl });

                } catch (error) {
                    if (append) {
                        state.infiniteScrollRetries++;
                        if (state.infiniteScrollRetries <= MAX_RETRIES) {
                            retryMessage.textContent = `載入失敗，5秒後重試 (${state.infiniteScrollRetries}/${MAX_RETRIES})`;
                            retryIndicator.classList.add('show');
                            setTimeout(() => {
                                state.isLoading = false; 
                                loadArticles(board, url, true);
                            }, 5000);
                        } else {
                            retryMessage.textContent = '自動重試失敗，請稍後再試';
                            setTimeout(() => retryIndicator.classList.remove('show'), 3000);
                            state.infiniteScrollRetries = 0;
                            state.isLoading = false; 
                        }
                    } else {
                        listErrorText.textContent = error.message;
                        listError.classList.remove('hidden');
                        state.isLoading = false;
                    }
                } finally {
                    if (!append || state.infiniteScrollRetries === 0 || state.infiniteScrollRetries > MAX_RETRIES) {
                        state.isLoading = false;
                    }
                    hideSkeleton();
                    infiniteLoader.classList.add('hidden');
                }
            }

            function parsePushCount(c) { if (c === '爆') return 100; if (typeof c === 'number') return c; if (typeof c === 'string') { if (c.startsWith('X')) return -10 - parseInt(c.substring(1), 10); const n = parseInt(c, 10); return isNaN(n) ? 0 : n; } return 0; }

            function renderAndSortArticles() {
                let articles = state.viewingFavorites ? [...state.favorites] : [...state.allArticles];
                const dislikedLinks = new Set(state.dislikedArticles.map(a => a.link));
                articles = articles.filter(a => !dislikedLinks.has(a.link));
                if (state.sortBy === 'hot') articles.sort((a, b) => parsePushCount(b.push_count) - parsePushCount(a.push_count));
                renderArticles(articles);
            }
            
            async function toggleFavorite() {
                if (!state.currentArticle || !userId || (auth.currentUser?.isAnonymous)) { showToast('請登入 Google 帳號'); return; };
                const a = state.currentArticle; const docId = a.link.replace(/[^a-zA-Z0-9]/g, '');
                const docRef = doc(db, 'users', userId, 'favorites', docId);
                if (isFavorite(a.link)) { await deleteDoc(docRef); showToast('已從我的最愛移除'); } 
                else { await setDoc(docRef, a); showToast('已加入我的最愛'); }
            }

            async function handleDislikeArticle() {
                if (!state.currentArticle || !userId || (auth.currentUser?.isAnonymous)) { showToast('請登入 Google 帳號'); return; };
                const a = state.currentArticle; const docId = a.link.replace(/[^a-zA-Z0-9]/g, '');
                const docRef = doc(db, 'users', userId, 'disliked_articles', docId);
                try { await setDoc(docRef, { link: a.link, title: a.title }); showToast('已加入不喜歡列表'); goBack(); } 
                catch (e) { showToast('操作失敗'); }
            }

            async function showDetailView(article) {
                state.currentArticle = article; state.currentView = 'detail';
                updateHeader(); floatingBackBtn.classList.remove('hidden'); showFloatingBackButton();
                if (!state.readArticles.has(article.link)) { state.readArticles.add(article.link); saveReadArticles(); const li = document.querySelector(`[data-link="${article.link}"]`); if(li) li.classList.add('opacity-60'); }
                listView.classList.add('hidden'); detailView.classList.remove('hidden');
                detailContent.innerHTML = '<div class="flex justify-center items-center py-20"><div class="loader h-16 w-16"></div></div>';
                history.pushState({view: 'detail'}, '', '#detail');
                
                try {
                    const res = await fetch(`/api/scraper?article_url=${encodeURIComponent(article.link)}`);
                    if (!res.ok) throw new Error(`無法載入內文: ${res.status}`);
                    const data = await res.json();
                    state.currentArticleImages = data.images || []; 
                    renderDetailContent(data, article);
                } catch (e) { detailContent.innerHTML = `<p class="text-red-500 p-4">${e.message}</p>`; }
            }
            
            function renderDetailContent(data, article) {
                const contentHTML = linkifyAndMediafy(data.content);
                const pushesHTML = data.pushes.map(p => {
                    const tagClass = `push-tag-${p.tag}`;
                    const contentWithMedia = linkifyAndMediafy(p.content);
                    return `<div class="push">
                                <div class="push-main"><span class="push-tag ${tagClass}">${p.tag}</span><span class="push-userid">${p.user}</span><span class="push-content">: ${contentWithMedia}</span></div>
                                <div class="push-time">${p.time}</div>
                            </div>`;
                }).join('');

                detailContent.innerHTML = `
                    <div class="p-3 rounded-lg text-sm mb-4 bg-gray-100 dark:bg-gray-800">
                        <p><strong>看板:</strong> ${article.board}</p><p><strong>作者:</strong> ${data.author_full}</p>
                        <p><strong>標題:</strong> ${article.title}</p><p><strong>時間:</strong> ${data.formatted_timestamp}</p>
                    </div>
                    <div class="text-base leading-relaxed whitespace-pre-wrap break-words">${contentHTML}</div>
                    <hr class="my-4 border-gray-300 dark:border-gray-600">
                    <div class="pushes-container">${pushesHTML}</div>`;
                detailContent.scrollTop = 0;
            }

            detailContent.addEventListener('click', e => {
                const image = e.target.closest('.article-image');
                if (image) {
                    const originalUrl = image.dataset.originalUrl;
                    const idx = state.currentArticleImages.indexOf(originalUrl);
                    if (idx > -1) openImageModal(idx);
                    return;
                }
                const thumbnail = e.target.closest('.youtube-thumbnail');
                if (thumbnail) {
                    e.preventDefault();
                    const videoId = thumbnail.dataset.youtubeId;
                    const iframe = document.createElement('div');
                    iframe.className = 'youtube-container';
                    iframe.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    thumbnail.replaceWith(iframe);
                }
            });

            function goBack() { history.back(); }
            boardSelector.addEventListener('change', e => { state.currentBoard = e.target.value; state.viewingFavorites = false; updateFavoritesButtonState(); loadArticles(state.currentBoard); });
            headerFavoriteBtn.addEventListener('click', toggleFavorite);
            headerDislikeBtn.addEventListener('click', handleDislikeArticle);
            headerBackBtn.addEventListener('click', goBack);
            floatingBackBtn.addEventListener('click', goBack);
            
            window.addEventListener('popstate', () => {
                if (!imageModal.classList.contains('hidden')) closeImageModal();
                else if (state.currentView === 'detail') {
                    state.currentView = 'list';
                    listView.classList.remove('hidden'); detailView.classList.add('hidden');
                    floatingBackBtn.classList.add('hidden'); updateHeader();
                }
            });

            articlesList.addEventListener('scroll', () => { 
                if (state.isLoading || !state.prevPageUrl || state.viewingFavorites) return; 
                const { scrollTop, scrollHeight, clientHeight } = articlesList; 
                if (scrollTop + clientHeight >= scrollHeight - 300) {
                    loadArticles(state.currentBoard, state.prevPageUrl, true);
                }
            });

            function cleanupImageInstance() { if (state.pinchZoomInstance) { if (state.pinchZoomInstance._wheelHandler) pinchZoomTarget.removeEventListener('wheel', state.pinchZoomInstance._wheelHandler); if (typeof state.pinchZoomInstance.destroy === 'function') state.pinchZoomInstance.destroy(); } state.pinchZoomInstance = null; pinchZoomTarget.innerHTML = ''; }

            function openImageModal(index) {
                cleanupImageInstance();
                state.currentImageIndex = index; const url = state.currentArticleImages[index]; if (!url) return;
                pinchZoomTarget.innerHTML = `<img src="/api/scraper?proxy_url=${encodeURIComponent(url)}">`;
                imageModal.classList.remove('hidden'); imageModalControls.classList.remove('hidden');
                updateImageNavButtons();
                if (!history.state || history.state.view !== 'image-modal') history.pushState({ view: 'image-modal' }, 'Image', '#image');
                try {
                    state.pinchZoomInstance = new PinchZoom.default(pinchZoomTarget, { minZoom: 0.5, maxZoom: 8 });
                    const wheelHandler = e => { e.preventDefault(); const inst = state.pinchZoomInstance; if (!inst) return; try { const rect = pinchZoomTarget.getBoundingClientRect(); const scale = inst.getScale(); let newScale = e.deltaY < 0 ? scale * 1.2 : scale / 1.2; newScale = Math.max(inst.options.minZoom, Math.min(newScale, inst.options.maxZoom)); if (newScale !== scale) inst.zoomTo(newScale, { x: e.clientX - rect.left, y: e.clientY - rect.top }); } catch(err) {} };
                    pinchZoomTarget.addEventListener('wheel', wheelHandler, { passive: false });
                    state.pinchZoomInstance._wheelHandler = wheelHandler;
                } catch (e) { console.error("pinch-zoom-js 初始化失敗:", e); }
            }
            
            // === 修正：確實隱藏控制按鈕 ===
            function closeImageModal() { 
                if (imageModal.classList.contains('hidden')) return; 
                cleanupImageInstance(); 
                imageModal.classList.add('hidden'); 
                imageModalControls.classList.add('hidden'); 
            };
            function handleCloseRequest(e) { if (e) e.stopPropagation(); if (history.state?.view === 'image-modal') history.back(); else closeImageModal(); };
            function showNextImage(e) { e.stopPropagation(); if (state.currentImageIndex < state.currentArticleImages.length - 1) openImageModal(state.currentImageIndex + 1); }
            function showPrevImage(e) { e.stopPropagation(); if (state.currentImageIndex > 0) openImageModal(state.currentImageIndex - 1); }
            function updateImageNavButtons() { imagePrevBtn.disabled = state.currentImageIndex === 0; imageNextBtn.disabled = state.currentImageIndex >= state.currentArticleImages.length - 1; }

            imageModal.addEventListener('click', handleCloseRequest);
            closeModalBtn.addEventListener('click', handleCloseRequest);
            pinchZoomTarget.addEventListener('click', e => e.stopPropagation());
            imagePrevBtn.addEventListener('click', showPrevImage);
            imageNextBtn.addEventListener('click', showNextImage);

            downloadBtn.addEventListener('click', async e => {
                e.stopPropagation(); const url = state.currentArticleImages[state.currentImageIndex]; if (!url) return;
                showToast('正在準備下載...'); downloadBtn.disabled = true;
                try {
                    const res = await fetch(`/api/scraper?proxy_url=${encodeURIComponent(url)}`);
                    if (!res.ok) throw new Error(`伺服器錯誤: ${res.status}`);
                    const blob = await res.blob(); const objUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.style.display = 'none'; a.href = objUrl;
                    a.download = url.split('/').pop().split('?')[0] || 'download';
                    document.body.appendChild(a); a.click(); URL.revokeObjectURL(objUrl); a.remove(); showToast('下載已開始');
                } catch (err) { showToast('下載失敗'); window.open(url, '_blank'); } finally { downloadBtn.disabled = false; }
            });
            
            clearCacheBtn.addEventListener('click', () => {
                Object.keys(localStorage).forEach(key => { if (key.startsWith('ptt-cache-')) localStorage.removeItem(key); });
                localStorage.removeItem('readArticles');
                state.readArticles.clear();
                renderAndSortArticles();
                showToast(`已清除所有快取與已讀記錄`);
            });

            function updateFavoritesButtonState() { const isV = state.viewingFavorites; favIconOutline.classList.toggle('hidden', isV); favIconSolid.classList.toggle('hidden', !isV); toggleFavoritesBtn.classList.toggle('bg-red-100', isV); toggleFavoritesBtn.classList.toggle('dark:bg-red-900/50', isV); }
            toggleFavoritesBtn.addEventListener('click', () => { if (auth.currentUser?.isAnonymous) { showToast('請登入 Google 帳號'); return; } state.viewingFavorites = !state.viewingFavorites; updateFavoritesButtonState(); if (state.viewingFavorites) { hideSkeleton(); listError.classList.add('hidden'); renderAndSortArticles(); } else { loadArticles(state.currentBoard); } });
            
            toggleSortBtn.addEventListener('click', () => { 
                state.sortBy = state.sortBy === 'time' ? 'hot' : 'time'; 
                sortTimeIcon.classList.toggle('hidden', state.sortBy === 'hot'); 
                sortHotIcon.classList.toggle('hidden', state.sortBy === 'time'); 
                renderAndSortArticles();
                articlesList.scrollTop = 0;
            });

            const toggleFullscreen = () => { if (!document.fullscreenElement) docEl.requestFullscreen(); else document.exitFullscreen(); };
            fullscreenToggleList.addEventListener('click', toggleFullscreen);
            fullscreenToggleDetail.addEventListener('click', toggleFullscreen);
            
            function showFloatingBackButton() { if (state.currentView !== 'detail') return; floatingBackBtn.classList.remove('opacity-0'); clearTimeout(state.inactivityTimer); state.inactivityTimer = setTimeout(() => floatingBackBtn.classList.add('opacity-0'), 3000); }
            document.addEventListener('mousemove', showFloatingBackButton);
            document.addEventListener('touchstart', showFloatingBackButton);

            for (const board in TOP_BOARDS) { const opt = document.createElement('option'); opt.value = board; opt.textContent = TOP_BOARDS[board]; if (board === state.currentBoard) opt.selected = true; boardSelector.appendChild(opt); }
            history.replaceState({view: 'list'}, '', '#list');
            loadArticles(state.currentBoard);
            updateHeader();
        });
    </script>
</body>
</html>
