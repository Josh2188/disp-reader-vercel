<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA 相關設定 -->
    <title>PTT Reader</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PTT Reader">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Viewer.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Fredoka:wght@500;600&display=swap" rel="stylesheet">
    <style>
        /* === 基本設置 === */
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            background-color: #020617; 
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 70%);
            background-attachment: fixed;
            overscroll-behavior-x: none;
        }
        .font-logo { font-family: 'Fredoka', sans-serif; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* === 動畫效果 === */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }

        /* === 捲軸隱藏 === */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .line-clamp-3 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; }
        
        /* === 毛玻璃與質感 === */
        .glassmorphism { background-color: rgba(15, 23, 42, 0.9); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.08); }
        .card-bg { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(4px); }

        /* === Viewer.js 客製化 === */
        .viewer-backdrop { background-color: rgba(0, 0, 0, 0.98) !important; }
        .viewer-container { touch-action: none; } 
        /* 隱藏 Viewer.js 預設按鈕 */
        .viewer-play, .viewer-flip-horizontal, .viewer-flip-vertical, .viewer-one-to-one, .viewer-zoom-in, .viewer-zoom-out, .viewer-rotate-left, .viewer-rotate-right { display: none; }
        /* 調整 Toolbar 位置與樣式 */
        .viewer-toolbar { width: auto; margin: 0 auto; bottom: 20px; border-radius: 99px; background-color: rgba(50,50,50,0.5); backdrop-filter: blur(5px); }
        .viewer-toolbar > ul > li { width: 44px; height: 44px; background-color: transparent; }
        .viewer-toolbar > ul > li:hover { background-color: rgba(255,255,255,0.1); border-radius: 50%; }
        
        #viewer-custom-overlay { pointer-events: none; }
        #viewer-custom-overlay button { pointer-events: auto; }

        /* === Tooltip === */
        .btn-tooltip { position: relative; }
        .btn-tooltip::after { content: attr(data-title); position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(5px) scale(0.95); padding: 4px 8px; background: rgba(15, 23, 42, 0.95); color: #e2e8f0; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; font-size: 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: all 0.2s ease; pointer-events: none; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .btn-tooltip:hover::after { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(5px) scale(1); }

        /* === 內容樣式 === */
        /* 回歸 object-cover 讓版面整齊美觀 */
        .thumbnail-base { flex-shrink: 0; overflow: hidden; border-radius: 0.5rem; background-color: #1e293b; box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1); position: relative; }
        .thumbnail-base img { width: 100%; height: 100%; object-fit: cover; object-position: center; transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1); }
        .thumbnail-base:hover img { transform: scale(1.05); }
        
        .push { display: flex; flex-wrap: wrap; align-items: baseline; margin-bottom: 0.25rem; line-height: 1.35; }
        .push-tag { flex-shrink: 0; width: 2rem; font-weight: 600; text-align: center; }
        .push-tag-推 { color: #22c55e; } .push-tag-噓 { color: #ef4444; } .push-tag-→ { color: #9ca3af; }
        .push-userid { flex-shrink: 0; font-weight: 600; margin-right: 0.5rem; }
        .push-content { flex-grow: 999; flex-basis: 0; min-width: 50%; word-break: break-all; margin-right: 0.5rem; }
        .push-info { flex-grow: 1; min-width: 130px; text-align: right; font-size: 0.75rem; color: #64748b; white-space: nowrap; }

        .youtube-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; margin: 0.5rem 0; border-radius: 0.5rem; box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.3); }
        .youtube-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .youtube-thumbnail { cursor: pointer; position: relative; display: block; }
        .youtube-thumbnail::after { content: '▶'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; color: white; background-color: rgba(0,0,0,0.5); width: 60px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 10px; line-height: 42px; padding-left: 5px; backdrop-filter: blur(4px); }
        
        /* 影片容器 */
        .video-container { width: 100%; margin: 0.5rem 0; border-radius: 0.5rem; overflow: hidden; background-color: #000; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .video-container video { width: 100%; height: auto; display: block; max-height: 80vh; }

        .article-image { cursor: pointer; border-radius: 0.5rem; transition: filter 0.2s; }
        .article-image:hover { filter: brightness(0.9); }

        #gallery-grid { column-gap: 0.5rem; padding: 0.5rem; }
        .gallery-item { margin-bottom: 0.5rem; break-inside: avoid; cursor: pointer; display: block; position: relative; overflow: hidden; border-radius: 0.5rem; background-color: #1e293b; }
        .gallery-item img { width: 100%; height: auto; display: block; transition: transform 0.5s ease; object-fit: contain; }
        .gallery-item:hover img { transform: scale(1.05); }
        .gallery-item .fav-overlay { position: absolute; top: 8px; right: 8px; color: white; background-color: rgba(0,0,0,0.5); border-radius: 50%; padding: 4px; display: none; backdrop-filter: blur(2px); }
        .gallery-item.is-favorite .fav-overlay { display: block; }

        /* RWD 欄位 (新增 xs - 3欄) */
        #gallery-grid.size-xs { column-count: 3; } @media (min-width: 640px) { #gallery-grid.size-xs { column-count: 4; } }
        #gallery-grid.size-sm { column-count: 2; } @media (min-width: 640px) { #gallery-grid.size-sm { column-count: 3; } } @media (min-width: 1024px) { #gallery-grid.size-sm { column-count: 4; } }
        #gallery-grid.size-md { column-count: 2; } @media (min-width: 640px) { #gallery-grid.size-md { column-count: 2; } } @media (min-width: 1024px) { #gallery-grid.size-md { column-count: 3; } }
        #gallery-grid.size-lg { column-count: 1; } @media (min-width: 640px) { #gallery-grid.size-lg { column-count: 2; } }

        /* === 主題配色 === */
        .theme-default .text-main-title { color: #e2e8f0; } .theme-default .text-main-link { color: #60a5fa; } .theme-default .text-main-content { color: #cbd5e1; } .theme-default .push-userid { color: #60a5fa; } .theme-default .text-read { color: #64748b !important; }
        .theme-cyan .text-main-title { color: #cffafe; } .theme-cyan .text-main-link { color: #22d3ee; } .theme-cyan .text-main-content { color: #d1d5db; } .theme-cyan .push-userid { color: #22d3ee; } .theme-cyan .text-read { color: #57737a !important; }
        .theme-amber .text-main-title { color: #fef3c7; } .theme-amber .text-main-link { color: #fbbf24; } .theme-amber .text-main-content { color: #d6d3d1; } .theme-amber .push-userid { color: #fbbf24; } .theme-amber .text-read { color: #78716c !important; }
        .theme-lime .text-main-title { color: #ecfccb; } .theme-lime .text-main-link { color: #a3e635; } .theme-lime .text-main-content { color: #d1d5db; } .theme-lime .push-userid { color: #a3e635; } .theme-lime .text-read { color: #5f6654 !important; }
        .theme-rose .text-main-title { color: #fce7f3; } .theme-rose .text-main-link { color: #f472b6; } .theme-rose .text-main-content { color: #e5e7eb; } .theme-rose .push-userid { color: #f472b6; } .theme-rose .text-read { color: #835a6d !important; }
        .theme-violet .text-main-title { color: #ede9fe; } .theme-violet .text-main-link { color: #a78bfa; } .theme-violet .text-main-content { color: #e2e8f0; } .theme-violet .push-userid { color: #a78bfa; } .theme-violet .text-read { color: #6d6085 !important; }
        .theme-emerald .text-main-title { color: #d1fae5; } .theme-emerald .text-main-link { color: #34d399; } .theme-emerald .text-main-content { color: #d1d5db; } .theme-emerald .push-userid { color: #34d399; } .theme-emerald .text-read { color: #4b665a !important; }

        /* === 選單 Chips === */
        .board-chip { white-space: nowrap; padding: 6px 16px; border-radius: 9999px; font-size: 0.9rem; font-weight: 500; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background-color: rgba(51, 65, 85, 0.5); color: #94a3b8; border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(4px); }
        .board-chip.active { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); border-color: rgba(59, 130, 246, 0.5); transform: translateY(-1px); }
        .board-chip:hover:not(.active) { background-color: rgba(71, 85, 105, 0.6); color: #f1f5f9; }

        @media (min-width: 768px) { #app-container { max-width: 48rem; } }
        @media (min-width: 1024px) { #app-container { max-width: 64rem; } }
        @media (min-width: 1280px) { #app-container { max-width: none; } }
    </style>
</head>
<body class="text-gray-100 theme-default min-h-screen">

    <div id="app-container" class="mx-auto min-h-screen shadow-2xl shadow-black flex flex-col relative bg-transparent">
        <header id="main-header" class="bg-slate-900/80 shadow-sm sticky top-0 z-20 glassmorphism transition-all duration-300">
            <div class="flex items-center justify-between p-3 pb-1 gap-2">
                <div class="flex items-center gap-3 overflow-hidden flex-grow cursor-pointer group" id="app-logo-btn" title="返回">
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <div class="w-9 h-9 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl shadow-lg shadow-blue-500/20 flex items-center justify-center transform group-hover:scale-105 transition-transform duration-200 ring-1 ring-white/10">
                            <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                            </svg>
                        </div>
                        <div class="flex flex-col">
                            <span class="font-logo font-bold text-lg leading-none tracking-wide text-white group-hover:text-blue-400 transition-colors drop-shadow-sm">PTT</span>
                            <span class="text-[10px] text-gray-400 font-medium tracking-widest uppercase">Reader</span>
                        </div>
                    </div>
                    <h2 id="header-title" class="font-bold text-base truncate text-blue-100 hidden ml-2 border-l border-gray-700 pl-3"></h2>
                </div>

                <div class="flex-shrink-0 flex items-center gap-1">
                    <div id="list-view-controls" class="flex items-center gap-1">
                        <button id="beauty-mode-btn" class="btn-tooltip p-2 rounded-full hover:bg-white/10 flex items-center gap-1 text-pink-400 hover:text-pink-300 transition-colors" data-title="美圖牆">
                            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                        </button>
                        <button id="toggle-sort-btn" class="btn-tooltip p-2 rounded-full hover:bg-white/10 flex items-center gap-1 text-gray-400 hover:text-white transition-colors" data-title="切換排序">
                            <svg id="sort-time-icon" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <svg id="sort-hot-icon" class="h-6 w-6 hidden text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.362-3.797A8.333 8.333 0 0112 6c1.23 0 2.398.256 3.362.714z" /></svg>
                        </button>
                        <div id="user-controls" class="hidden items-center gap-1">
                            <button id="toggle-favorites-btn" class="btn-tooltip p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition-colors" data-title="我的最愛">
                                <svg id="fav-icon-outline" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
                                <svg id="fav-icon-solid" class="h-6 w-6 hidden text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            </button>
                        </div>
                        <button id="theme-toggle-btn" class="btn-tooltip p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition-colors" data-title="切換主題"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.098 19.902a3.75 3.75 0 005.304 0l6.401-6.402a3.75 3.75 0 00-.625-6.25a3.75 3.75 0 00-6.25-.625l-6.402 6.401a3.75 3.75 0 000 5.304z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 4.5l-4.5 4.5" /></svg></button>
                        <button id="font-size-toggle-list" class="btn-tooltip p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition-colors" data-title="字體大小"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19V5h7v14m-7-7h7"/><path d="M14 19v-5a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v5m-7-2h7"/></svg></button>
                        <button id="fullscreen-toggle-list" class="btn-tooltip p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white hidden md:block transition-colors" data-title="全螢幕"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg></button>
                    </div>

                    <div id="detail-view-controls" class="flex-shrink-0 flex items-center gap-1 hidden">
                        <button id="header-favorite-btn" class="btn-tooltip p-2 rounded-full hover:bg-pink-900/40 transition-colors text-gray-400 hover:text-pink-400" data-title="加入/移除最愛"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg></button>
                        <button id="font-size-toggle-detail" class="btn-tooltip p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition-colors" data-title="字體大小"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19V5h7v14m-7-7h7"/><path d="M14 19v-5a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v5m-7-2h7"/></svg></button>
                        <button id="fullscreen-toggle-detail" class="btn-tooltip p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition-colors" data-title="全螢幕"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg></button>
                    </div>

                    <div id="gallery-view-controls" class="flex-shrink-0 flex items-center gap-1 hidden">
                         <button id="gallery-size-toggle-btn" class="btn-tooltip p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition-colors" data-title="切換縮圖尺寸"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 8.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 018.25 20.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg></button>
                         <button id="fullscreen-toggle-gallery" class="btn-tooltip p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition-colors" data-title="全螢幕"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg></button>
                    </div>

                    <div id="auth-container" class="flex-shrink-0 ml-1">
                         <button id="google-login-btn" class="flex items-center justify-center bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-full hover:bg-blue-500 transition-colors text-sm whitespace-nowrap shadow-lg shadow-blue-900/50">登入</button>
                        <div id="user-info" class="hidden items-center"><div class="relative"><button id="avatar-btn"><img id="user-avatar" class="w-8 h-8 rounded-full cursor-pointer ring-2 ring-gray-700 hover:ring-gray-500 transition-all" src="" alt="User"></button><div id="logout-dropdown" class="hidden absolute right-0 mt-2 w-32 bg-slate-800 rounded-lg shadow-xl py-1 z-50 ring-1 ring-white/10"><button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-white/5 transition-colors">登出</button><button id="clear-cache-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-white/5 transition-colors">清除快取</button></div></div></div>
                    </div>
                </div>
            </div>

            <div id="board-scroller-container" class="px-3 pb-3 overflow-x-auto no-scrollbar flex items-center gap-2 border-b border-white/5"></div>
        </header>

        <div class="flex-grow relative">
            <div id="list-view" class="absolute inset-0 flex flex-col">
                <div id="skeleton-container" class="flex-grow divide-y divide-white/5 overflow-y-auto no-scrollbar"></div>
                <main id="articles-list" class="flex-grow divide-y divide-white/5 overflow-y-auto no-scrollbar hidden pb-20"></main>
                <div id="infinite-loader" class="flex justify-center items-center py-4 hidden"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-500 h-8 w-8"></div></div>
                <div id="list-error" class="text-center py-20 text-red-400 hidden"><p id="list-error-text"></p></div>
            </div>
            <div id="detail-view" class="absolute inset-0 hidden"><main id="detail-content" class="h-full overflow-y-auto no-scrollbar p-2 md:p-4 pb-24"></main></div>
            <div id="gallery-view" class="absolute inset-0 hidden flex flex-col">
                <main id="gallery-grid" class="flex-grow overflow-y-auto no-scrollbar pb-20 pt-2"></main>
                <div id="gallery-loader-initial" class="absolute inset-0 flex justify-center items-center"><div class="loader h-16 w-16"></div></div>
                <div id="gallery-loader-more" class="flex justify-center items-center py-4 hidden"><div class="loader h-8 w-8"></div></div>
                 <div id="gallery-error" class="text-center py-20 text-red-500 hidden"><p id="gallery-error-text"></p></div>
            </div>
        </div>
    </div>

    <!-- Viewer.js 浮動控制層 -->
    <div id="viewer-custom-overlay" class="hidden fixed top-0 left-0 w-full h-full z-[2016] flex flex-col justify-between pointer-events-none">
        <div class="flex justify-end p-4 pt-4 gap-3">
            <button id="viewer-download-btn" class="bg-black/40 backdrop-blur-md text-white p-3 rounded-full hover:bg-blue-600/80 transition-all border border-white/10 pointer-events-auto shadow-lg" title="下載圖片">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            </button>
            <button id="viewer-zoom-cycle-btn" class="bg-black/40 backdrop-blur-md text-white p-3 rounded-full hover:bg-blue-600/80 transition-all border border-white/10 pointer-events-auto shadow-lg" title="循環縮放">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path></svg>
            </button>
            <button id="viewer-favorite-btn" class="bg-black/40 backdrop-blur-md text-white p-3 rounded-full hover:bg-pink-600/80 transition-all border border-white/10 pointer-events-auto shadow-lg" title="收藏">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
            </button>
        </div>
    </div>
    
    <!-- 浮動返回按鈕：在手機版 (hidden) 隱藏，在中型螢幕以上 (md:flex) 顯示 -->
    <button id="floating-back-btn" class="fixed bottom-6 right-6 z-40 p-4 bg-blue-600 text-white rounded-full shadow-lg shadow-blue-900/50 transition-transform active:scale-95 hover:bg-blue-500 hover:scale-105 border border-white/10 hidden md:flex items-center justify-center">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
    </button>
    
    <div id="toast-notification" class="bg-slate-800 border border-slate-600 text-white text-sm py-3 px-6 rounded-full shadow-2xl"><p id="toast-message"></p></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = { apiKey: "AIzaSyBVK9oYxwz7Wrg4d5dz1eNQyRTigDtHxbQ", authDomain: "my-english-learning-app-5d864.firebaseapp.com", projectId: "my-english-learning-app-5d864", storageBucket: "my-english-learning-app-5d864.appspot.com", messagingSenderId: "748913890079", appId: "1:748913890079:web:dad0719760593d43e7962a" };
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            let userId = null;
            let unsubscribeFavorites = null, unsubscribeDisliked = null;

            const cache = { get(key) { const itemStr = localStorage.getItem(key); if (!itemStr) return null; try { const item = JSON.parse(itemStr); if (new Date().getTime() > item.expiry) { localStorage.removeItem(key); return null; } return item.data; } catch (e) { return null; } }, set(key, data) { const item = { data: data, expiry: new Date().getTime() + 10 * 60 * 1000 }; localStorage.setItem(key, JSON.stringify(item)); } };

            let state = { currentBoard: 'Gossiping', prevPageUrl: null, isLoading: false, currentView: 'list', currentArticle: null, favorites: [], dislikedArticles: [], readArticles: new Set(JSON.parse(localStorage.getItem('readArticles')) || []), viewerInstance: null, currentArticleImages: [], allArticles: [], galleryItems: [], galleryPrevPageUrl: null, sortBy: 'time', viewingFavorites: false, loadRetries: 0, retryTimer: null, fontSize: localStorage.getItem('fontSize') || 'md', gallerySize: localStorage.getItem('gallerySize') || 'sm', currentModalGalleryItem: null, touchStartX: 0, touchStartY: 0, isScrolling: false };
            const MAX_RETRIES = 5;

            const el = id => document.getElementById(id);
            const docEl = document.documentElement;
            const bodyEl = document.body;
            const appContainer = el('app-container');
            const listView = el('list-view'), detailView = el('detail-view'), galleryView = el('gallery-view');
            const articlesList = el('articles-list'), galleryGrid = el('gallery-grid'), galleryLoaderInitial = el('gallery-loader-initial'), galleryLoaderMore = el('gallery-loader-more');
            const skeletonContainer = el('skeleton-container'), infiniteLoader = el('infinite-loader'), listError = el('list-error');
            const listErrorText = el('list-error-text'), boardScroller = el('board-scroller-container');
            const headerTitle = el('header-title'), detailContent = el('detail-content'), floatingBackBtn = el('floating-back-btn');
            const clearCacheBtn = el('clear-cache-btn'), toggleFavoritesBtn = el('toggle-favorites-btn');
            const favIconOutline = el('fav-icon-outline'), favIconSolid = el('fav-icon-solid'), toggleSortBtn = el('toggle-sort-btn');
            const sortTimeIcon = el('sort-time-icon'), sortHotIcon = el('sort-hot-icon'), listViewControls = el('list-view-controls');
            const detailViewControls = el('detail-view-controls'), galleryViewControls = el('gallery-view-controls');
            const googleLoginBtn = el('google-login-btn'), userInfo = el('user-info'), userAvatar = el('user-avatar');
            const logoutBtn = el('logout-btn'), userControls = el('user-controls'), avatarBtn = el('avatar-btn');
            const logoutDropdown = el('logout-dropdown');
            const fullscreenToggleList = el('fullscreen-toggle-list'), fullscreenToggleDetail = el('fullscreen-toggle-detail'), fullscreenToggleGallery = el('fullscreen-toggle-gallery');
            const headerFavoriteBtn = el('header-favorite-btn');
            const fontSizeToggleDetail = el('font-size-toggle-detail'), fontSizeToggleList = el('font-size-toggle-list'), themeToggleBtn = el('theme-toggle-btn');
            const galleryError = el('gallery-error'), galleryErrorText = el('gallery-error-text');
            const gallerySizeToggleBtn = el('gallery-size-toggle-btn');
            const appLogoBtn = el('app-logo-btn');
            const beautyModeBtn = el('beauty-mode-btn');
            
            // Viewer.js 自訂按鈕
            const viewerCustomOverlay = el('viewer-custom-overlay');
            const viewerZoomCycleBtn = el('viewer-zoom-cycle-btn');
            const viewerFavoriteBtn = el('viewer-favorite-btn');
            const viewerDownloadBtn = el('viewer-download-btn');

            const TOP_BOARDS = { "Hot": "熱門", "Gossiping": "八卦", "Stock": "股票", "Beauty": "表特", "Lifeismoney": "省錢", "MobileComm": "手機", "Sex": "西斯", "Boy-Girl": "男女", "Tech_Job": "科技", "HatePolitics": "政黑", "KoreaStar": "韓星", "movie": "電影", "e-shopping": "網購" };
            const BOARD_KEYS = Object.keys(TOP_BOARDS);

            onAuthStateChanged(auth, user => {
                if (unsubscribeFavorites) unsubscribeFavorites(); if (unsubscribeDisliked) unsubscribeDisliked();
                if (user && !user.isAnonymous) {
                    userId = user.uid;
                    googleLoginBtn.classList.add('hidden'); userInfo.classList.remove('hidden'); userControls.classList.remove('hidden'); userAvatar.src = user.photoURL;
                    unsubscribeFavorites = onSnapshot(collection(db, 'users', userId, 'favorites'), snap => { 
                        state.favorites = snap.docs.map(d => d.data()); 
                        if (state.viewingFavorites) renderAndSortArticles(); 
                        if(state.currentView === 'detail' && state.currentArticle) updateFavoriteIcon(isFavorite(state.currentArticle.link));
                        if(state.currentView === 'gallery') updateGalleryFavoriteIcons();
                        if(state.viewerInstance) updateFavoriteFromOverlay();
                    });
                    unsubscribeDisliked = onSnapshot(collection(db, 'users', userId, 'disliked_articles'), snap => { state.dislikedArticles = snap.docs.map(d => d.data()); renderAndSortArticles(); });
                } else { userId = user ? user.uid : null; googleLoginBtn.classList.remove('hidden'); userInfo.classList.add('hidden'); userControls.classList.add('hidden'); state.favorites = []; state.dislikedArticles = []; if (!user) signInAnonymously(auth).catch(e => console.error("匿名登入失敗:", e)); }
            });

            const showToast = message => { const t = el('toast-notification'); el('toast-message').textContent = message; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };
            const saveReadArticles = () => localStorage.setItem('readArticles', JSON.stringify([...state.readArticles]));
            const isFavorite = link => state.favorites.some(fav => fav.link === link);

            function linkifyAndMediafy(text) { 
                if (!text) return ''; 
                const urlRegex = /(https?:\/\/[^\s<>"]+)/g; 
                const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/; 
                const imageRegex = /\.(jpg|jpeg|png|gif|avif|webp)$/i; 
                const videoRegex = /\.(mp4|webm|mov)($|\?)/i;
                const imgurGifvRegex = /imgur\.com\/([a-zA-Z0-9]+)\.gifv/i;
                
                const escapeHTML = str => str.replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag)); 
                let processedText = escapeHTML(text).replace(/\n/g, '<br>'); 
                
                return processedText.replace(urlRegex, url => { 
                    const cleanUrl = url.split('&amp;')[0]; 
                    const ytMatch = cleanUrl.match(youtubeRegex); 
                    if (ytMatch) { 
                        const videoId = ytMatch[1]; 
                        return `<div class="youtube-container"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`; 
                    }
                    if (videoRegex.test(cleanUrl)) {
                         return `<div class="video-container"><video src="${cleanUrl}" controls playsinline loop muted preload="metadata"></video></div>`;
                    }
                    const gifvMatch = cleanUrl.match(imgurGifvRegex);
                    if (gifvMatch) {
                        const mp4Url = `https://i.imgur.com/${gifvMatch[1]}.mp4`;
                        return `<div class="video-container"><video src="${mp4Url}" controls playsinline loop muted autoplay></video></div>`;
                    }
                    const hasImageExtension = imageRegex.test(cleanUrl); 
                    const isKnownImageHost = /^(https?:\/\/)(i\.)?(imgur\.com|meee\.com\.tw|sl\.loli\.net|upload\.cc)\//.test(cleanUrl); 
                    if (hasImageExtension || isKnownImageHost) { 
                        const proxiedUrl = `/api/scraper?proxy_url=${encodeURIComponent(cleanUrl)}`; 
                        return `<img src="${proxiedUrl}" alt="圖片" class="article-image my-2 rounded-lg max-w-full h-auto shadow-md cursor-pointer" data-original-url="${cleanUrl}" loading="lazy">`; 
                    } 
                    return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" class="text-main-link hover:underline break-all">${cleanUrl}</a>`; 
                }); 
            }
            
            function updateHeader() { 
                const isDetail = state.currentView === 'detail'; 
                const isGallery = state.currentView === 'gallery'; 
                boardScroller.classList.toggle('hidden', isDetail || isGallery);
                listViewControls.classList.toggle('hidden', isDetail || isGallery); 
                galleryViewControls.classList.toggle('hidden', !isGallery); 
                detailViewControls.classList.toggle('hidden', !isDetail); 
                headerTitle.classList.toggle('hidden', !isDetail);
                if (isDetail && state.currentArticle) { 
                    headerTitle.textContent = state.currentArticle.title; 
                    updateFavoriteIcon(isFavorite(state.currentArticle.link)); 
                }
                document.querySelectorAll('.board-chip').forEach(chip => {
                    if (chip.dataset.board === state.currentBoard) { chip.classList.add('active'); chip.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); } 
                    else { chip.classList.remove('active'); }
                });
            }

            function switchToView(viewName) { 
                ['list', 'detail', 'gallery'].forEach(view => el(`${view}-view`).classList.toggle('hidden', view !== viewName)); 
                state.currentView = viewName; 
                updateHeader();
                // 浮動按鈕邏輯已由 CSS hidden md:flex 取代
            }

            function createSkeletonItem() { return `<div class="flex items-start p-2 gap-2 animate-pulse border-b border-white/5"><div class="flex flex-col flex-grow"><div class="h-5 bg-white/10 rounded w-3/4 mb-2"></div><div class="h-3 bg-white/10 rounded w-1/3 mb-3"></div><div class="h-4 bg-white/10 rounded w-full mb-1"></div></div><div class="w-20 h-20 bg-white/10 rounded-md flex-shrink-0"></div></div>`; }
            function showSkeleton() { skeletonContainer.innerHTML = Array(8).fill(createSkeletonItem()).join(''); skeletonContainer.classList.remove('hidden'); articlesList.classList.add('hidden'); }
            function hideSkeleton() { skeletonContainer.classList.add('hidden'); articlesList.classList.remove('hidden'); }
            function updateFavoriteIcon(isFav) { if(auth.currentUser && !auth.currentUser.isAnonymous) headerFavoriteBtn.querySelector('svg').classList.toggle('fill-pink-500', isFav); }
            
            function renderArticles(articleData) { 
                const fragment = document.createDocumentFragment(); 
                articleData.forEach((article, index) => fragment.appendChild(createListItem(article, index))); 
                articlesList.innerHTML = ''; 
                articlesList.appendChild(fragment); 
            }

            function getPushCountBgClass(c) { 
                if (c === '爆') return 'text-red-400 border border-red-900/50 bg-red-900/10'; 
                if (typeof c === 'number' && c >= 50) return 'text-yellow-400 border border-yellow-900/50 bg-yellow-900/10'; 
                if (typeof c === 'number' && c >= 10) return 'text-green-400 border border-green-900/50 bg-green-900/10'; 
                if (typeof c === 'string' && c.startsWith('X')) return 'text-gray-500 bg-gray-900'; 
                return 'text-blue-400 bg-blue-900/10'; 
            }

            function createListItem(article, index) { 
                const item = document.createElement('div'); 
                const isRead = state.readArticles.has(article.link);
                const baseClass = `p-2 border-b border-white/5 hover:bg-white/5 cursor-pointer active:bg-white/10 transition-all duration-300 animate-fade-in-up ${isRead ? 'opacity-75' : ''}`;
                const titleClass = isRead ? 'text-read' : 'text-main-title';
                
                const images = article.images || (article.thumbnail ? [article.thumbnail] : []);
                const hasImage = images.length > 0;
                
                let layoutType = 'standard';
                if (hasImage) {
                    if (images.length >= 3) layoutType = 'collage-3'; 
                    else if (images.length === 2) layoutType = 'collage-2'; 
                    else if (index > 0 && index % 8 === 0) layoutType = 'big-card'; 
                    else if (index % 2 !== 0) layoutType = 'left-thumb';
                    else layoutType = 'right-thumb';
                } else {
                    layoutType = 'no-image';
                }

                if (layoutType === 'big-card' || layoutType === 'collage-3' || layoutType === 'collage-2') item.className = `${baseClass} flex flex-col gap-2`;
                else if (layoutType === 'left-thumb') item.className = `${baseClass} flex flex-row-reverse gap-2 items-start`;
                else item.className = `${baseClass} flex flex-row gap-2 items-start`;

                item.dataset.link = article.link; 
                
                const pushClass = getPushCountBgClass(article.push_count);
                const pushHTML = article.push_count ? `<span class="flex-shrink-0 ml-auto text-xs font-mono px-2 py-0.5 rounded ${pushClass}">${article.push_count}</span>` : ''; 
                const boardNameHTML = state.currentBoard === 'Hot' ? `<span class="text-xs text-blue-400 mr-2 bg-blue-900/30 px-1.5 py-0.5 rounded border border-blue-900/50">${article.board}</span>` : ''; 
                const timestampText = article.formatted_timestamp ? `${article.formatted_timestamp.split(' ')[0]}` : `${article.date}`; 
                const snippetClass = (layoutType === 'big-card' || layoutType.startsWith('collage')) ? 'line-clamp-3' : 'line-clamp-2';
                const snippetText = article.snippet || ''; 
                
                let mediaHTML = ''; 
                if (hasImage) { 
                    if (layoutType === 'collage-3') {
                        const imgs = images.slice(0, 3).map(src => `<div class="thumbnail-base w-full h-24 overflow-hidden rounded"><img src="/api/scraper?proxy_url=${encodeURIComponent(src)}" loading="lazy" class="w-full h-full object-cover"></div>`).join('');
                        mediaHTML = `<div class="grid grid-cols-3 gap-1 mt-1 w-full">${imgs}</div>`;
                    } else if (layoutType === 'collage-2') {
                        const imgs = images.slice(0, 2).map(src => `<div class="thumbnail-base w-full h-32 overflow-hidden rounded"><img src="/api/scraper?proxy_url=${encodeURIComponent(src)}" loading="lazy" class="w-full h-full object-cover"></div>`).join('');
                        mediaHTML = `<div class="grid grid-cols-2 gap-1 mt-1 w-full">${imgs}</div>`;
                    } else {
                        const proxiedImageUrl = `/api/scraper?proxy_url=${encodeURIComponent(images[0])}`; 
                        let containerClass = "thumbnail-base relative group rounded overflow-hidden";
                        if (layoutType === 'big-card') containerClass += " w-full aspect-video mt-1"; 
                        else {
                            const sizeVar = index % 5;
                            if (sizeVar === 0) containerClass += " w-24 h-24"; 
                            else if (sizeVar === 1) containerClass += " w-20 h-28"; 
                            else if (sizeVar === 2) containerClass += " w-28 h-28";
                            else containerClass += " w-24 h-24";
                        }
                        mediaHTML = `<div data-thumbnail-for="${article.link}" class="${containerClass}"><img src="${proxiedImageUrl}" alt="thumbnail" loading="lazy" class="w-full h-full object-cover"></div>`; 
                    }
                } 
                
                item.innerHTML = `
                    <div class="flex flex-col overflow-hidden flex-grow">
                        <div class="flex items-start justify-between mb-1">
                            <h3 class="font-bold text-base leading-snug ${titleClass} line-clamp-2 pr-2 transition-colors">${boardNameHTML}${article.title}</h3>
                            ${pushHTML}
                        </div>
                        <div class="flex items-center text-xs text-gray-400 mt-0.5">
                            <span class="mr-2">${article.author}</span>
                            <span>• ${timestampText}</span>
                        </div>
                        <p class="text-sm text-main-content mt-1 ${snippetClass} leading-tight opacity-80">${snippetText}</p>
                    </div>
                    ${mediaHTML}`; 
                
                item.addEventListener('click', () => { 
                    cancelRetry(); 
                    const a = state.allArticles.find(a => a.link === article.link) || state.favorites.find(a => a.link === article.link); 
                    if (a) showDetailView(a); 
                }); 
                return item; 
            }
            
            function updatePreviewsUI(previews) { previews.forEach(previewData => { const articleInState = state.allArticles.find(a => a.link === previewData.link); if (articleInState) { Object.assign(articleInState, previewData); const existingItem = articlesList.querySelector(`[data-link="${previewData.link}"]`); if (existingItem) { const parent = existingItem.parentNode; const index = Array.from(parent.children).indexOf(existingItem); const newItem = createListItem(articleInState, index); existingItem.replaceWith(newItem); } } }); }

            async function fetchPreviewsInChunks(articles) { const articlesToFetch = articles.filter(a => typeof a.snippet === 'undefined'); if (articlesToFetch.length === 0) return; const CHUNK_SIZE = 5; const articleLinks = articlesToFetch.map(a => a.link); for (let i = 0; i < articleLinks.length; i += CHUNK_SIZE) { const chunk = articleLinks.slice(i, i + CHUNK_SIZE); if (chunk.length === 0) continue; try { const res = await fetch('/api/previews', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ urls: chunk }) }); if (!res.ok) continue; updatePreviewsUI(await res.json()); } catch (error) { console.error(`批次預覽錯誤:`, error); } } }
            function cancelRetry() { if (state.retryTimer) { clearTimeout(state.retryTimer); state.retryTimer = null; } state.loadRetries = 0; state.isLoading = false; }
            async function loadArticles(board, url = null, append = false) { if (state.isLoading) return; state.isLoading = true; listError.classList.add('hidden'); const isHotBoard = board === 'Hot'; if (!append) { cancelRetry(); articlesList.innerHTML = ''; if (!isHotBoard && cache.get(`ptt-cache-${board}`)) { const cachedData = cache.get(`ptt-cache-${board}`); state.allArticles = cachedData.articles; state.prevPageUrl = cachedData.prevPageUrl; renderAndSortArticles(); fetchPreviewsInChunks(state.allArticles); } else { showSkeleton(); } } else { infiniteLoader.classList.remove('hidden'); } try { const listUrl = url || `https://www.ptt.cc/bbs/${board}/index.html`; const fetchUrl = isHotBoard ? `/api/scraper?board=Hot` : `/api/scraper?board=${board}&list_url=${encodeURIComponent(listUrl)}`; const res = await fetch(fetchUrl); if (!res.ok) throw new Error(`請求失敗: ${res.status}`); const listData = await res.json(); const newArticles = listData.articles.filter(a => a.title && !a.title.includes('[公告]')); const existingLinks = append ? new Set(state.allArticles.map(a => a.link)) : new Set(); const uniqueNewArticles = append ? newArticles.filter(a => !existingLinks.has(a.link)) : newArticles; if (append && uniqueNewArticles.length === 0 && listData.prev_page_url) { throw new Error("頁面載入不完整"); } cancelRetry(); if (append) state.allArticles.push(...uniqueNewArticles); else state.allArticles = uniqueNewArticles; state.prevPageUrl = listData.prev_page_url; renderAndSortArticles(); fetchPreviewsInChunks(uniqueNewArticles); if (!append && !isHotBoard) { cache.set(`ptt-cache-${board}`, { articles: state.allArticles, prevPageUrl: state.prevPageUrl }); } state.isLoading = false; } catch (error) { state.loadRetries++; if (state.loadRetries <= MAX_RETRIES) { state.retryTimer = setTimeout(() => { state.isLoading = false; loadArticles(board, url, append); }, 2000 * state.loadRetries); } else { if (!append) { listErrorText.textContent = error.message; listError.classList.remove('hidden'); } cancelRetry(); } } finally { if (!append) hideSkeleton(); infiniteLoader.classList.add('hidden'); } }

            function parsePushCount(c) { if (c === '爆') return 100; if (typeof c === 'number') return c; if (typeof c === 'string') { if (c.startsWith('X')) return -10 - parseInt(c.substring(1), 10); const n = parseInt(c, 10); return isNaN(n) ? 0 : n; } return 0; }
            function renderAndSortArticles() { let articles = state.viewingFavorites ? [...state.favorites] : [...state.allArticles]; const dislikedLinks = new Set(state.dislikedArticles.map(a => a.link)); articles = articles.filter(a => !dislikedLinks.has(a.link)); if (state.sortBy === 'hot' && state.currentBoard !== 'Hot') { articles.sort((a, b) => parsePushCount(b.push_count) - parsePushCount(a.push_count)); } renderArticles(articles); }
            
            async function showDetailView(article, fromHistory = false) { 
                state.currentArticle = article; 
                switchToView('detail'); 
                if (!state.readArticles.has(article.link)) { state.readArticles.add(article.link); saveReadArticles(); const li = document.querySelector(`[data-link="${article.link}"]`); if(li) { li.classList.add('opacity-75'); const title = li.querySelector('h3'); if(title) title.classList.replace('text-main-title', 'text-read'); } } 
                detailContent.innerHTML = '<div class="flex justify-center items-center py-20"><div class="loader h-12 w-12 border-blue-500"></div></div>'; 
                if (!fromHistory) { history.pushState({view: 'detail', articleLink: article.link}, '', '#detail'); } 
                try { const res = await fetch(`/api/scraper?article_url=${encodeURIComponent(article.link)}`); if (!res.ok) throw new Error(`無法載入: ${res.status}`); const data = await res.json(); state.currentArticleImages = data.images || []; renderDetailContent(data, article); } catch (e) { detailContent.innerHTML = `<p class="text-red-500 p-8 text-center">${e.message}</p>`; } 
            }

            function renderDetailContent(data, article) { 
                const contentHTML = linkifyAndMediafy(data.content); 
                const pushesHTML = data.pushes.map(p => { 
                    const tagClass = `push-tag-${p.tag}`; 
                    const cleanedContent = (p.content || '').trim().replace(/^:/, '').trim(); 
                    const contentWithMedia = linkifyAndMediafy(cleanedContent); 
                    return `<div class="push border-b border-white/5 pb-1 mb-1"><span class="push-tag ${tagClass}">${p.tag}</span><span class="push-userid text-main-link">${p.user}</span><span class="push-content text-main-content text-sm leading-normal">${contentWithMedia}</span><span class="push-info">${p.time}</span></div>`; 
                }).join(''); 
                
                detailContent.innerHTML = `
                    <div class="mb-3 p-3 rounded-xl card-bg">
                        <h1 class="font-bold text-xl md:text-2xl leading-snug text-main-title mb-1 tracking-wide">${article.title}</h1>
                        <div class="flex items-center text-sm text-gray-400">
                            <div class="flex-grow">
                                <p><span class="text-blue-400 font-medium">${data.author_full}</span></p>
                                <p class="text-xs mt-0.5 opacity-70">${data.formatted_timestamp}</p>
                            </div>
                            <div class="text-xs px-3 py-1 bg-white/10 rounded-full border border-white/5">${article.board}</div>
                        </div>
                    </div>
                    <div class="text-base leading-normal whitespace-pre-wrap break-words text-main-content font-light tracking-wide px-1">${contentHTML}</div>
                    <div class="mt-4 pt-4 border-t border-white/10">
                        <h3 class="font-bold text-gray-400 mb-2 flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.772-1.165 2 2 0 01-3.91.009c-.52.01-1.04-.05-1.526-.174A2 2 0 012 18V8a2 2 0 012-2h14zM9 10h.01M15 10h.01M21 12h.01"/></svg>推文討論</h3>
                        <div class="pushes-container">${pushesHTML}</div>
                    </div>`; 
                detailContent.scrollTop = 0; 
            }

            function goBack(fromButton = false) { 
                if (state.viewerInstance) { state.viewerInstance.hide(); return; }
                if (state.currentView === 'detail' || state.currentView === 'gallery') { window.history.back(); } 
                else if (state.currentView === 'list') { articlesList.scrollTo({ top: 0, behavior: 'smooth' }); }
            }

            function onBackToList() { 
                state.currentView = 'list'; 
                const youtubeIframes = detailContent.querySelectorAll('.youtube-container'); 
                youtubeIframes.forEach(iframe => iframe.remove()); 
                switchToView('list'); 
            }

            window.addEventListener('popstate', (event) => { 
                if (state.viewerInstance) { state.viewerInstance.hide(); return; } 
                if (state.currentView === 'gallery' && (!event.state || event.state.view === 'list')) { switchToView('list'); } 
                else if (state.currentView === 'detail' && (!event.state || event.state.view === 'list')) { onBackToList(); } 
                else if (event.state && event.state.view === 'detail') { const article = state.allArticles.find(a => a.link === event.state.articleLink); if (article) showDetailView(article, true); }
            });

            async function loadGallery(append = false) { if (state.isLoading) return; state.isLoading = true; galleryError.classList.add('hidden'); if (!append) { cancelRetry(); galleryGrid.innerHTML = ''; state.galleryPrevPageUrl = null; galleryLoaderInitial.classList.remove('hidden'); } else { galleryLoaderMore.classList.remove('hidden'); } try { const url = append && state.galleryPrevPageUrl ? `/api/scraper?board=BeautyGallery&list_url=${encodeURIComponent(state.galleryPrevPageUrl)}` : `/api/scraper?board=BeautyGallery`; const res = await fetch(url); if (!res.ok) throw new Error(`請求失敗: ${res.status}`); const data = await res.json(); cancelRetry(); state.galleryPrevPageUrl = data.prev_page_url; const newItems = data.articles || []; if (append) { state.galleryItems.push(...newItems); } else { state.galleryItems = newItems; } renderGallery(newItems, append); } catch (error) { state.loadRetries++; if (state.loadRetries <= MAX_RETRIES) { state.retryTimer = setTimeout(() => { state.isLoading = false; loadGallery(append); }, 2000 * state.loadRetries); } else { if (!append) { galleryErrorText.textContent = error.message; galleryError.classList.remove('hidden'); } cancelRetry(); } } finally { state.isLoading = false; galleryLoaderInitial.classList.add('hidden'); galleryLoaderMore.classList.add('hidden'); } }
            
            function renderGallery(items, append = false) { 
                if (!append) galleryGrid.innerHTML = ''; 
                const fragment = document.createDocumentFragment(); 
                items.forEach(item => { 
                    const itemDiv = document.createElement('a'); 
                    itemDiv.className = 'gallery-item animate-fade-in-up'; 
                    itemDiv.dataset.articleLink = item.article.link; 
                    const proxiedUrl = `/api/scraper?proxy_url=${encodeURIComponent(item.preview_image)}`; 
                    itemDiv.innerHTML = `<img src="${proxiedUrl}" loading="lazy" alt="${item.article.title}" onerror="this.parentElement.style.display='none'"><div class="fav-overlay"><svg class="w-5 h-5 text-pink-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg></div>`; 
                    itemDiv.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        if (item.all_images && item.all_images.length > 0) { openImageViewer(item.all_images, item.all_images.indexOf(item.preview_image), item); } 
                        else { openImageViewer([item.preview_image], 0, item); }
                    }); 
                    fragment.appendChild(itemDiv); 
                }); 
                galleryGrid.appendChild(fragment); 
                updateGalleryFavoriteIcons(); 
            }
            
            function updateGalleryFavoriteIcons() { document.querySelectorAll('.gallery-item').forEach(item => { const link = item.dataset.articleLink; if (link) { item.classList.toggle('is-favorite', isFavorite(link)); } }); }

            function openImageViewer(images, index, contextItem = null) {
                if (state.viewerInstance) state.viewerInstance.destroy();
                
                const div = document.createElement('div');
                div.style.display = 'none';
                images.forEach(src => {
                    const img = document.createElement('img');
                    img.src = `/api/scraper?proxy_url=${encodeURIComponent(src)}`;
                    if (contextItem && contextItem.article) {
                        img.dataset.articleLink = contextItem.article.link;
                    } else if (state.currentArticle) {
                        img.dataset.articleLink = state.currentArticle.link;
                    }
                    div.appendChild(img);
                });
                document.body.appendChild(div);

                const viewer = new Viewer(div, {
                    initialViewIndex: index,
                    inline: false,
                    button: true,
                    navbar: true,
                    title: true,
                    transition: false, // 關閉過渡動畫解決閃爍
                    zoomRatio: 0.5,
                    minZoomRatio: 0.1, // 允許縮得更小，避免回彈
                    maxZoomRatio: 10,
                    toolbar: {
                        zoomIn: 1, zoomOut: 1, oneToOne: 1, reset: 1, prev: 1, play: 0, next: 1, rotateLeft: 1, rotateRight: 1, flipHorizontal: 0, flipVertical: 0,
                    },
                    hidden() {
                        viewer.destroy();
                        div.remove();
                        state.viewerInstance = null;
                        viewerCustomOverlay.classList.add('hidden');
                    },
                    view(e) {
                        state.currentImageIndex = e.detail.index;
                        const originalImg = e.detail.originalImage;
                        if (originalImg && originalImg.dataset.articleLink) {
                            state.currentModalGalleryItem = { article: { link: originalImg.dataset.articleLink } };
                            updateFavoriteFromOverlay();
                        }
                    },
                    ready() {
                        viewerCustomOverlay.classList.remove('hidden');
                        updateFavoriteFromOverlay();
                        
                        // === 關鍵修正：手勢滑動 ===
                        // 注入自訂手勢邏輯到 Viewer.js 容器
                        const viewerContainer = document.querySelector('.viewer-container');
                        if (viewerContainer) {
                            let startX = 0;
                            let startY = 0;
                            
                            viewerContainer.addEventListener('touchstart', (e) => {
                                startX = e.changedTouches[0].clientX;
                                startY = e.changedTouches[0].clientY;
                            }, { passive: false });

                            viewerContainer.addEventListener('touchend', (e) => {
                                const endX = e.changedTouches[0].clientX;
                                const endY = e.changedTouches[0].clientY;
                                const diffX = endX - startX;
                                const diffY = endY - startY;

                                // 判斷水平滑動
                                if (Math.abs(diffX) > 50 && Math.abs(diffY) < 50) {
                                    // 檢查是否放大中
                                    const imageData = viewer.imageData;
                                    const initialImageData = viewer.initialImageData;
                                    // 如果放大比例 > 初始比例 + 容許值，則不切換
                                    if (imageData.ratio > initialImageData.ratio * 1.05) return;

                                    e.preventDefault(); 
                                    if (diffX > 0) viewer.prev();
                                    else viewer.next();
                                }
                            }, { passive: false });
                        }
                    }
                });
                
                state.viewerInstance = viewer;
                viewer.show();
            }

            function updateFavoriteFromOverlay() {
                if (!state.currentModalGalleryItem) return;
                const isFav = isFavorite(state.currentModalGalleryItem.article.link);
                viewerFavoriteBtn.querySelector('svg').classList.toggle('fill-current', isFav);
                viewerFavoriteBtn.querySelector('svg').classList.toggle('text-pink-500', isFav);
            }

            // 循環放大邏輯 (修復)
            const zoomLevels = [1.5, 2, 2.5, 3, 4, 5, 1];
            let currentZoomIdx = 0;
            viewerZoomCycleBtn.addEventListener('click', () => {
                if (!state.viewerInstance) return;
                const targetRatio = zoomLevels[currentZoomIdx];
                
                if (targetRatio === 1) {
                    state.viewerInstance.reset();
                } else {
                    const initialRatio = state.viewerInstance.initialImageData.ratio;
                    state.viewerInstance.zoomTo(initialRatio * targetRatio, true);
                }
                
                showToast(`縮放: ${targetRatio * 100}%`);
                currentZoomIdx = (currentZoomIdx + 1) % zoomLevels.length;
            });

            // 下載功能實現
            viewerDownloadBtn.addEventListener('click', async () => {
                if (!state.viewerInstance) return;
                const currentImg = state.viewerInstance.image;
                if (!currentImg) return;
                
                const src = currentImg.src;
                // 從 src 提取原始 URL (如果是 proxy url)
                // 例如 /api/scraper?proxy_url=...
                let originalUrl = src;
                try {
                    const urlObj = new URL(src, window.location.origin);
                    if(urlObj.searchParams.has('proxy_url')) {
                        originalUrl = decodeURIComponent(urlObj.searchParams.get('proxy_url'));
                    }
                } catch(e) {}

                showToast('正在準備下載...');
                try {
                    const res = await fetch(src); // Fetch from proxy to avoid CORS
                    if (!res.ok) throw new Error('Download failed');
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    // 嘗試從原始 URL 獲取檔名
                    const filename = originalUrl.split('/').pop().split('?')[0] || 'download.jpg';
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    showToast('下載完成');
                } catch (e) {
                    console.error(e);
                    showToast('下載失敗，嘗試開啟原圖');
                    window.open(originalUrl, '_blank');
                }
            });

            viewerFavoriteBtn.addEventListener('click', async () => {
                if (!state.currentModalGalleryItem || !userId || (auth.currentUser?.isAnonymous)) { showToast('請登入 Google 帳號'); return; };
                const a = state.currentModalGalleryItem.article;
                const docId = a.link.replace(/[^a-zA-Z0-9]/g, '');
                const docRef = doc(db, 'users', userId, 'favorites', docId);
                if (isFavorite(a.link)) { await deleteDoc(docRef); showToast('已移除'); }
                else { await setDoc(docRef, a); showToast('已收藏'); }
                updateFavoriteFromOverlay();
            });

            const fontSizes = { sm: '16px', md: '18px', lg: '20px' }; const fontSizeKeys = ['sm', 'md', 'lg'];
            function applyFontSize(sizeKey) { if (!fontSizes[sizeKey]) return; docEl.style.fontSize = fontSizes[sizeKey]; localStorage.setItem('fontSize', sizeKey); state.fontSize = sizeKey; }
            function toggleFontSize() { const currentIndex = fontSizeKeys.indexOf(state.fontSize); const nextIndex = (currentIndex + 1) % fontSizeKeys.length; const nextSizeKey = fontSizeKeys[nextIndex]; applyFontSize(nextSizeKey); showToast(`字體已切換為 ${nextSizeKey === 'sm' ? '小' : nextSizeKey === 'md' ? '中' : '大'}`); }
            const themes = ['theme-default', 'theme-cyan', 'theme-amber', 'theme-lime', 'theme-rose', 'theme-violet', 'theme-emerald']; let currentThemeIndex = themes.indexOf(localStorage.getItem('colorTheme') || 'theme-default'); if(currentThemeIndex === -1) currentThemeIndex = 0;
            function applyTheme(themeName) { themes.forEach(t => bodyEl.classList.remove(t)); bodyEl.classList.add(themeName); localStorage.setItem('colorTheme', themeName); }
            
            const gallerySizes = ['xs', 'sm', 'md', 'lg'];
            function applyGallerySize(sizeKey) { if (!gallerySizes.includes(sizeKey)) return; gallerySizes.forEach(s => galleryGrid.classList.remove(`size-${s}`)); galleryGrid.classList.add(`size-${sizeKey}`); localStorage.setItem('gallerySize', sizeKey); state.gallerySize = sizeKey; }
            function toggleGallerySize() { const currentIndex = gallerySizes.indexOf(state.gallerySize); const nextIndex = (currentIndex + 1) % gallerySizes.length; const nextSizeKey = gallerySizes[nextIndex]; applyGallerySize(nextSizeKey); const sizeMap = { xs: '特小', sm: '小', md: '中', lg: '大' }; showToast(`縮圖尺寸已切換為 ${sizeMap[nextSizeKey]}`); }

            // 手勢操作 - 一般頁面
            function handleTouchStart(e) { state.touchStartX = e.changedTouches[0].screenX; state.touchStartY = e.changedTouches[0].screenY; state.isScrolling = false; }
            function handleTouchMove(e) { if (state.isScrolling) return; const deltaX = e.changedTouches[0].screenX - state.touchStartX; const deltaY = e.changedTouches[0].screenY - state.touchStartY; if (Math.abs(deltaY) > Math.abs(deltaX) + 10) { state.isScrolling = true; } }
            function handleTouchEnd(e) { if (state.isScrolling) { state.isScrolling = false; return; } const deltaX = e.changedTouches[0].screenX - state.touchStartX; const deltaY = e.changedTouches[0].screenY - state.touchStartY; const swipeThreshold = 80; if (Math.abs(deltaX) > swipeThreshold && Math.abs(deltaX) > Math.abs(deltaY) * 2) { if (deltaX < 0) { goBack(state.currentView === 'detail'); } } }

            let listTouchStartX = 0;
            let listTouchStartY = 0;
            const listViewEl = el('list-view');

            listViewEl.addEventListener('touchstart', (e) => {
                listTouchStartX = e.touches[0].clientX;
                listTouchStartY = e.touches[0].clientY;
            }, { passive: true });

            listViewEl.addEventListener('touchend', (e) => {
                if (state.currentView !== 'list') return;

                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = touchEndX - listTouchStartX;
                const diffY = touchEndY - listTouchStartY;

                if (Math.abs(diffX) > 80 && Math.abs(diffY) < 60) {
                    const currentIndex = BOARD_KEYS.indexOf(state.currentBoard);
                    if (currentIndex === -1) return;

                    let nextIndex = -1;
                    if (diffX < 0) { 
                        nextIndex = (currentIndex + 1) % BOARD_KEYS.length;
                    } else { 
                        nextIndex = (currentIndex - 1 + BOARD_KEYS.length) % BOARD_KEYS.length;
                    }

                    if (nextIndex !== -1) {
                        const nextBoard = BOARD_KEYS[nextIndex];
                        const chip = document.querySelector(`.board-chip[data-board="${nextBoard}"]`);
                        if (chip) chip.click();
                    }
                }
            }, { passive: true });

            beautyModeBtn.addEventListener('click', () => {
                cancelRetry();
                state.currentBoard = 'BeautyGallery'; 
                state.viewingFavorites = false;
                
                document.querySelectorAll('.board-chip').forEach(c => c.classList.remove('active'));
                updateHeader();

                switchToView('gallery');
                history.pushState({view: 'gallery'}, '', '#gallery');
                loadGallery(false);
            });

            appLogoBtn.addEventListener('click', () => goBack(true));

            function renderBoardSelector() {
                boardScroller.innerHTML = '';
                for (const board in TOP_BOARDS) {
                    const btn = document.createElement('button');
                    btn.className = 'board-chip flex-shrink-0';
                    btn.textContent = TOP_BOARDS[board];
                    btn.dataset.board = board;
                    
                    btn.addEventListener('click', () => {
                        cancelRetry();
                        state.currentBoard = board;
                        state.viewingFavorites = false;
                        updateHeader();

                        const isHotBoard = board === 'Hot';
                        toggleSortBtn.style.display = isHotBoard ? 'none' : 'flex';
                        if (isHotBoard) state.sortBy = 'hot';
                        switchToView('list');
                        loadArticles(board);
                    });
                    boardScroller.appendChild(btn);
                }
            }

            googleLoginBtn.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); showToast(`登入成功！`); } catch (e) { showToast('Google 登入失敗'); } });
            logoutBtn.addEventListener('click', async () => { try { await signOut(auth); showToast('您已成功登出'); } catch (e) { showToast('登出時發生錯誤'); } });
            avatarBtn.addEventListener('click', e => { e.stopPropagation(); logoutDropdown.classList.toggle('hidden'); });
            window.addEventListener('click', () => { if (!logoutDropdown.classList.contains('hidden')) logoutDropdown.classList.add('hidden'); });
            
            floatingBackBtn.addEventListener('click', () => goBack(true));
            
            headerFavoriteBtn.addEventListener('click', async () => { if (!state.currentArticle || !userId || (auth.currentUser?.isAnonymous)) { showToast('請登入 Google 帳號'); return; }; const a = state.currentArticle; const docId = a.link.replace(/[^a-zA-Z0-9]/g, ''); const docRef = doc(db, 'users', userId, 'favorites', docId); if (isFavorite(a.link)) { await deleteDoc(docRef); showToast('已從我的最愛移除'); } else { await setDoc(docRef, a); showToast('已加入我的最愛'); } });
            articlesList.addEventListener('scroll', () => { if (state.isLoading || !state.prevPageUrl || state.viewingFavorites || state.currentBoard === 'Hot') return; const { scrollTop, scrollHeight, clientHeight } = articlesList; if (scrollTop + clientHeight >= scrollHeight - 300) loadArticles(state.currentBoard, state.prevPageUrl, true); });
            galleryGrid.addEventListener('scroll', () => { if (state.isLoading || !state.galleryPrevPageUrl) return; const { scrollTop, scrollHeight, clientHeight } = galleryGrid; if (scrollTop + clientHeight >= scrollHeight - 500) { loadGallery(true); } });
            toggleSortBtn.addEventListener('click', () => { cancelRetry(); state.sortBy = state.sortBy === 'time' ? 'hot' : 'time'; sortTimeIcon.classList.toggle('hidden', state.sortBy === 'hot'); sortHotIcon.classList.toggle('hidden', state.sortBy === 'time'); renderAndSortArticles(); articlesList.scrollTop = 0; });
            toggleFavoritesBtn.addEventListener('click', () => { if (auth.currentUser?.isAnonymous) { showToast('請登入 Google 帳號'); return; } state.viewingFavorites = !state.viewingFavorites; updateFavoritesButtonState(); if (state.viewingFavorites) { hideSkeleton(); listError.classList.add('hidden'); renderAndSortArticles(); } else { loadArticles(state.currentBoard); } });
            function updateFavoritesButtonState() { const isV = state.viewingFavorites; favIconOutline.classList.toggle('hidden', isV); favIconSolid.classList.toggle('hidden', !isV); toggleFavoritesBtn.classList.toggle('text-gray-400', !isV); toggleFavoritesBtn.classList.toggle('text-red-500', isV); }
            
            detailContent.addEventListener('click', e => { 
                const image = e.target.closest('.article-image'); 
                if (image) { 
                    const originalUrl = image.dataset.originalUrl; 
                    let idx = state.currentArticleImages.indexOf(originalUrl); 
                    if (idx === -1) { state.currentArticleImages.push(originalUrl); idx = state.currentArticleImages.length - 1; }
                    openImageViewer(state.currentArticleImages, idx);
                    return; 
                } 
                const thumbnail = e.target.closest('.youtube-thumbnail'); 
                if (thumbnail) { 
                    e.preventDefault(); 
                    const videoId = thumbnail.dataset.youtubeId; 
                    const iframe = document.createElement('div'); 
                    iframe.className = 'youtube-container'; 
                    iframe.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`; 
                    thumbnail.replaceWith(iframe); 
                } 
            });
            
            clearCacheBtn.addEventListener('click', () => { Object.keys(localStorage).forEach(key => { if (key.startsWith('ptt-cache-')) localStorage.removeItem(key); }); localStorage.removeItem('readArticles'); state.readArticles.clear(); renderAndSortArticles(); showToast(`已清除所有快取與已讀記錄`); });
            const toggleFullscreen = () => { if (!document.fullscreenElement) docEl.requestFullscreen(); else document.exitFullscreen(); };
            fullscreenToggleList.addEventListener('click', toggleFullscreen);
            fullscreenToggleDetail.addEventListener('click', toggleFullscreen);
            fullscreenToggleGallery.addEventListener('click', toggleFullscreen);
            fontSizeToggleDetail.addEventListener('click', toggleFontSize);
            fontSizeToggleList.addEventListener('click', toggleFontSize);
            themeToggleBtn.addEventListener('click', () => { currentThemeIndex = (currentThemeIndex + 1) % themes.length; applyTheme(themes[currentThemeIndex]); showToast('已切換顏色主題'); });
            gallerySizeToggleBtn.addEventListener('click', toggleGallerySize);
            
            if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered.', reg), err => console.log('SW registration failed: ', err)); }); }

            function initialize() {
                renderBoardSelector();
                applyFontSize(state.fontSize);
                applyTheme(themes[currentThemeIndex]);
                applyGallerySize(state.gallerySize);
                
                history.replaceState({view: 'list'}, '', '#list');
                loadArticles(state.currentBoard);
                updateHeader();
            }
            initialize();
        });
    </script>
</body>
</html>