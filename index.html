<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTT 行動版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pinch-zoom-js@2.3.4/dist/pinch-zoom.umd.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 基本樣式與動畫 */
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
        #article-content a { color: #3b82f6; text-decoration: underline; }
        #article-content .richcontent { margin-top: 1rem; margin-bottom: 1rem; }
        .push-tag { min-width: 2.5rem; }
        .view-container { transition: transform 0.3s ease-in-out; }
        .view-container.hidden { display: none; }
        .slide-in-from-right { transform: translateX(100%); }
        .slide-out-to-left { transform: translateX(-100%); }
        .slide-in-from-left { transform: translateX(-100%); }
        .slide-out-to-right { transform: translateX(100%); }
        #floating-back-btn { transition: opacity 0.3s ease-in-out; }
        .richcontent iframe, .richcontent img { max-width: 100%; height: auto; margin: 0 auto; display: block; }
        pinch-zoom { display: block; overflow: hidden; width: 100%; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden flex flex-col">

    <!-- 頂部導覽列 -->
    <header id="main-header" class="bg-white shadow-md sticky top-0 z-10 flex items-center justify-between px-2 sm:px-4 h-16 flex-shrink-0">
        <!-- 左側返回按鈕 -->
        <button id="back-btn" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400 hidden">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>
        
        <!-- 中間標題/看板選擇器 -->
        <div class="flex-1 min-w-0 flex items-center justify-center">
            <div id="list-header" class="flex items-center space-x-2">
                <h1 class="text-lg font-bold">看板</h1>
                <select id="board-selector" class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2"></select>
            </div>
            <h2 id="detail-header-title" class="text-lg font-bold truncate hidden px-2"></h2>
        </div>
        
        <!-- 右側控制按鈕 -->
        <div class="flex items-center space-x-1 sm:space-x-2">
            <button id="history-btn" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
            <button id="favorite-btn" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400 hidden">
                <svg id="favorite-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 016.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
            </button>
            <button id="fullscreen-btn" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                <svg id="fullscreen-enter-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4 0l-5-5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5 5"></path></svg>
                <svg id="fullscreen-exit-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 4H4v6m10-6h6v6m-6 4h6v6m-10-6H4v6"></path></svg>
            </button>
            <!-- 使用者大頭貼與下拉選單 -->
            <div class="relative">
                <button id="profile-btn" class="w-9 h-9 rounded-full overflow-hidden bg-gray-200 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400">
                    <img src="https://placehold.co/40x40/E2E8F0/4A5568?text=J" alt="使用者大頭貼" class="w-full h-full object-cover">
                </button>
                <div id="profile-dropdown" class="absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                    <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">登出</a>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要內容區域 -->
    <main id="main-content" class="flex-1 overflow-hidden relative">
        <!-- 文章列表 -->
        <div id="list-view" class="view-container absolute inset-0 overflow-y-auto">
            <div id="article-list" class="divide-y divide-gray-200"></div>
            <div id="pagination" class="flex justify-center items-center py-4 px-2 space-x-2"></div>
            <div id="list-loader" class="text-center py-8 hidden">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
                <p class="mt-2 text-gray-500">載入中...</p>
            </div>
        </div>

        <!-- 文章內容 -->
        <div id="detail-view" class="view-container absolute inset-0 overflow-y-auto bg-white hidden">
            <div id="article-container" class="p-4 sm:p-6 max-w-4xl mx-auto">
                <div id="article-meta"></div>
                <div id="article-content" class="mt-4 text-lg leading-relaxed break-words"></div>
                <div id="article-pushes" class="mt-8"></div>
            </div>
            <div id="detail-loader" class="text-center py-20 hidden">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
                <p class="mt-2 text-gray-500">文章載入中...</p>
            </div>
        </div>
        
        <!-- 圖片燈箱 -->
        <div id="lightbox" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center">
            <button id="lightbox-close" class="absolute top-4 right-4 text-white text-4xl">&times;</button>
            <div id="lightbox-content" class="w-full h-full flex items-center justify-center"></div>
        </div>
        
        <!-- 懸浮返回按鈕 (文章內) -->
        <button id="floating-back-btn" class="fixed bottom-6 right-6 bg-blue-500 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center opacity-0 z-20">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 元素 ---
            const mainContent = document.getElementById('main-content');
            const listView = document.getElementById('list-view');
            const detailView = document.getElementById('detail-view');
            const articleList = document.getElementById('article-list');
            const pagination = document.getElementById('pagination');
            const listLoader = document.getElementById('list-loader');
            const detailLoader = document.getElementById('detail-loader');
            const articleContainer = document.getElementById('article-container');
            const boardSelector = document.getElementById('board-selector');
            const backBtn = document.getElementById('back-btn');
            const listHeader = document.getElementById('list-header');
            const detailHeaderTitle = document.getElementById('detail-header-title');
            const favoriteBtn = document.getElementById('favorite-btn');
            const favoriteIcon = document.getElementById('favorite-icon');
            const lightbox = document.getElementById('lightbox');
            const lightboxContent = document.getElementById('lightbox-content');
            const lightboxClose = document.getElementById('lightbox-close');
            const floatingBackBtn = document.getElementById('floating-back-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const profileBtn = document.getElementById('profile-btn');
            const profileDropdown = document.getElementById('profile-dropdown');

            // --- 應用程式狀態 ---
            const state = {
                currentView: 'list',
                currentBoard: 'Beauty',
                listHistory: [],
                currentArticleUrl: null,
                currentArticleTitle: null,
                favorites: JSON.parse(localStorage.getItem('ptt-favorites')) || [],
                history: JSON.parse(localStorage.getItem('ptt-history')) || [],
                scrollPositions: {},
                inactivityTimer: null,
            };

            const TOP_BOARDS = {
                "Beauty": "表特", "Gossiping": "八卦", "Stock": "股票", "C_Chat": "希洽",
                "Lifeismoney": "省錢", "Tech_Job": "科技業", "NBA": "NBA", "Car": "汽車",
                "Boy-Girl": "男女", "Baseball": "棒球"
            };

            // --- 函數 ---
            function fetchAPI(params) {
                const url = new URL('/api', window.location.origin);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                return fetch(url).then(res => {
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return res.json();
                });
            }

            function loadArticles(board, listUrl = '') {
                listLoader.classList.remove('hidden');
                articleList.innerHTML = '';
                pagination.innerHTML = '';
                if (state.scrollPositions[listUrl || board]) {
                    listView.scrollTop = state.scrollPositions[listUrl || board];
                }

                fetchAPI({ board, list_url: listUrl })
                    .then(data => {
                        renderArticleList(data.articles);
                        renderPagination(data.pagination);
                        if (!listUrl) { // Only on initial board load
                            state.listHistory = [data.pagination.current_url];
                        }
                    })
                    .catch(error => {
                        console.error('載入文章列表失敗:', error);
                        articleList.innerHTML = `<div class="text-center text-red-500 p-8">無法載入文章列表，請稍後再試。</div>`;
                    })
                    .finally(() => listLoader.classList.add('hidden'));
            }
            
            function renderArticleList(articles) {
                articleList.innerHTML = articles.map(article => `
                    <a href="#detail" data-url="${article.url}" class="article-link block p-4 hover:bg-gray-50">
                        <div class="flex items-start space-x-2">
                            <span class="push-tag text-center font-bold ${getPushClass(article.push_count)} w-10 text-lg">${article.push_count || ' '}</span>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg truncate ${state.history.includes(article.url) ? 'text-gray-500' : 'text-blue-600'}">${article.title}</h3>
                                <div class="text-sm text-gray-500 mt-1 flex items-center justify-between">
                                    <span>${article.author}</span>
                                    <span>${article.date}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('');
            }

            function getPushClass(count) {
                if (count === '爆') return 'text-red-500';
                if (count >= 50) return 'text-yellow-500';
                if (count >= 10) return 'text-green-500';
                if (typeof count === 'string' && count.startsWith('X')) return 'text-gray-400';
                return 'text-blue-500';
            }

            function renderPagination(paginationData) {
                pagination.innerHTML = `
                    <a href="#" data-url="${paginationData.prev_url}" class="page-link px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 ${!paginationData.prev_url ? 'opacity-50 cursor-not-allowed' : ''}">‹ 上一頁</a>
                    <a href="#" data-url="${paginationData.next_url}" class="page-link px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 ${!paginationData.next_url ? 'opacity-50 cursor-not-allowed' : ''}">下一頁 ›</a>
                `;
            }

            function loadArticleContent(url) {
                detailLoader.classList.remove('hidden');
                articleContainer.classList.add('hidden');
                
                fetchAPI({ article_url: url })
                    .then(data => {
                        renderArticleContent(data);
                        state.currentArticleTitle = data.title;
                        if (!state.history.includes(url)) {
                            state.history.push(url);
                            localStorage.setItem('ptt-history', JSON.stringify(state.history));
                        }
                    })
                    .catch(error => {
                        console.error('載入文章內容失敗:', error);
                        articleContainer.innerHTML = `<div class="text-center text-red-500 p-8">無法載入文章內容，請稍後再試。</div>`;
                    })
                    .finally(() => {
                        detailLoader.classList.add('hidden');
                        articleContainer.classList.remove('hidden');
                        detailView.scrollTop = 0;
                    });
            }

            function renderArticleContent(data) {
                document.getElementById('article-meta').innerHTML = `
                    <h1 class="text-2xl sm:text-3xl font-bold mb-2">${data.title}</h1>
                    <div class="text-sm text-gray-500 border-b pb-4">
                        <p>作者: ${data.author}</p>
                        <p>看板: ${data.board}</p>
                        <p>時間: ${data.time}</p>
                    </div>`;
                
                // 代理圖片 URL
                const processedContent = data.content.replace(/https?:\/\/(i\.imgur\.com|i\.redd\.it|truth\.bahamut\.com\.tw|pbs\.twimg\.com)\S+/g, (match) => {
                    return `/api?proxy_url=${encodeURIComponent(match)}`;
                });

                document.getElementById('article-content').innerHTML = processedContent;
                document.getElementById('article-pushes').innerHTML = data.pushes.map(p => `
                    <div class="flex items-start space-x-2 mt-2">
                        <span class="push-tag text-center font-bold ${getPushClass(p.tag)}">${p.tag}</span>
                        <div class="flex-1">
                            <span class="font-bold">${p.user}</span>
                            <span class="text-gray-700">: ${p.content}</span>
                            <span class="text-xs text-gray-400 ml-2 whitespace-nowrap">${p.time}</span>
                        </div>
                    </div>
                `).join('');
                
                // 為圖片加上燈箱效果
                document.querySelectorAll('#article-content img').forEach(img => {
                    const parent = img.parentElement;
                    if (parent.tagName.toLowerCase() === 'a') {
                        parent.addEventListener('click', e => e.preventDefault());
                        parent.style.cursor = 'zoom-in';
                        parent.onclick = () => openLightbox(parent.href);
                    } else {
                        img.style.cursor = 'zoom-in';
                        img.onclick = () => openLightbox(img.src);
                    }
                });
            }

            function openLightbox(src) {
                lightbox.classList.remove('hidden');
                lightbox.classList.add('flex');
                lightboxContent.innerHTML = ''; // 清空舊內容
                const pinchZoomEl = document.createElement('pinch-zoom');
                const img = new Image();
                img.src = src;
                pinchZoomEl.appendChild(img);
                lightboxContent.appendChild(pinchZoomEl);
            }

            function switchView(view, url) {
                const oldView = state.currentView;
                state.currentView = view;

                if (view === 'detail') {
                    state.currentArticleUrl = url;
                    loadArticleContent(url);
                    
                    listView.classList.add('slide-out-to-left');
                    detailView.classList.remove('hidden', 'slide-in-from-left');
                    detailView.classList.add('slide-in-from-right');
                    
                    setTimeout(() => {
                        listView.classList.add('hidden');
                        listView.classList.remove('slide-out-to-left');
                    }, 300);

                } else { // 'list'
                    detailView.classList.add('slide-out-to-right');
                    listView.classList.remove('hidden', 'slide-in-from-right');
                    listView.classList.add('slide-in-from-left');

                    setTimeout(() => {
                        detailView.classList.add('hidden');
                        detailView.classList.remove('slide-out-to-right');
                        // 重新渲染列表以更新已讀狀態
                        const currentListUrl = state.listHistory[state.listHistory.length - 1];
                        loadArticles(state.currentBoard, currentListUrl);
                    }, 300);
                }
                updateHeader();
            }

            function updateHeader() {
                if (state.currentView === 'detail') {
                    listHeader.classList.add('hidden');
                    detailHeaderTitle.classList.remove('hidden');
                    detailHeaderTitle.textContent = state.currentArticleTitle || '載入中...';
                    backBtn.classList.remove('hidden');
                    favoriteBtn.classList.remove('hidden');
                    
                    // 更新愛心圖示狀態
                    const isFav = state.favorites.some(fav => fav.url === state.currentArticleUrl);
                    if (isFav) {
                        favoriteIcon.classList.add('text-red-500', 'fill-current');
                    } else {
                        favoriteIcon.classList.remove('text-red-500', 'fill-current');
                    }

                } else { // 'list'
                    listHeader.classList.remove('hidden');
                    detailHeaderTitle.classList.add('hidden');
                    backBtn.classList.add('hidden');
                    favoriteBtn.classList.add('hidden');
                }
            }
            
            // --- 事件監聽 ---
            boardSelector.addEventListener('change', (e) => {
                state.currentBoard = e.target.value;
                state.scrollPositions = {}; // 切換看板時重置滾動位置
                loadArticles(state.currentBoard);
            });

            articleList.addEventListener('click', (e) => {
                const link = e.target.closest('.article-link');
                if (link) {
                    e.preventDefault();
                    state.scrollPositions[state.listHistory[state.listHistory.length - 1] || state.currentBoard] = listView.scrollTop;
                    const url = link.dataset.url;
                    history.pushState({view: 'detail', url: url}, '', `#detail`);
                    switchView('detail', url);
                }
            });

            pagination.addEventListener('click', (e) => {
                const link = e.target.closest('.page-link');
                if (link && !link.classList.contains('cursor-not-allowed')) {
                    e.preventDefault();
                    const url = link.dataset.url;
                    if (url) {
                        state.listHistory.push(url);
                        loadArticles(state.currentBoard, url);
                        listView.scrollTop = 0;
                    }
                }
            });
            
            window.addEventListener('popstate', (e) => {
                if (e.state && e.state.view === 'detail') {
                    switchView('detail', e.state.url);
                } else {
                    switchView('list');
                }
            });

            backBtn.addEventListener('click', () => history.back());
            floatingBackBtn.addEventListener('click', () => history.back());

            favoriteBtn.addEventListener('click', () => {
                const articleUrl = state.currentArticleUrl;
                const articleTitle = state.currentArticleTitle;
                const favIndex = state.favorites.findIndex(fav => fav.url === articleUrl);

                if (favIndex > -1) { // 已在喜愛中，移除
                    state.favorites.splice(favIndex, 1);
                    favoriteIcon.classList.remove('text-red-500', 'fill-current');
                } else { // 不在喜愛中，加入
                    state.favorites.push({ title: articleTitle, url: articleUrl });
                    favoriteIcon.classList.add('text-red-500', 'fill-current');
                }
                localStorage.setItem('ptt-favorites', JSON.stringify(state.favorites));
            });
            
            // 大頭貼下拉選單邏輯
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('hidden');
            });
            
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                alert('已登出'); // 這裡可以換成更複雜的登出邏輯
                profileDropdown.classList.add('hidden');
            });

            // 點擊頁面其他地方關閉下拉選單
            window.addEventListener('click', () => {
                if (!profileDropdown.classList.contains('hidden')) {
                    profileDropdown.classList.add('hidden');
                }
            });

            lightboxClose.addEventListener('click', () => {
                lightbox.classList.add('hidden');
                lightbox.classList.remove('flex');
                lightboxContent.innerHTML = '';
            });

            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            });
            document.addEventListener('fullscreenchange', () => {
                const isFullscreen = !!document.fullscreenElement;
                document.getElementById('fullscreen-enter-icon').classList.toggle('hidden', isFullscreen);
                document.getElementById('fullscreen-exit-icon').classList.toggle('hidden', !isFullscreen);
            });
            
            function showFloatingBackButton() {
                if (state.currentView !== 'detail') return;
                floatingBackBtn.classList.remove('opacity-0');
                clearTimeout(state.inactivityTimer);
                state.inactivityTimer = setTimeout(() => floatingBackBtn.classList.add('opacity-0'), 3000);
            }
            document.addEventListener('mousemove', showFloatingBackButton);
            document.addEventListener('touchstart', showFloatingBackButton);

            // --- 初始載入 ---
            for (const board_en in TOP_BOARDS) {
                const option = document.createElement('option');
                option.value = board_en;
                option.textContent = TOP_BOARDS[board_en];
                if (board_en === state.currentBoard) option.selected = true;
                boardSelector.appendChild(option);
            }
            history.replaceState({view: 'list'}, '', '#list');
            loadArticles(state.currentBoard);
            updateHeader();
        });
    </script>
</body>
</html>
